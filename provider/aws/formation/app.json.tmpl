{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Outputs": {
    "Release": {
      "Value": "{{ .Release.Id }}"
    },
    "Services": {
      "Value": "{{ services .Manifest }}"
    }
  },
  "Parameters" : {
    {{ template "service-params" .Manifest }}

    "Rack": {
      "Type": "String",
      "MinLength": "1"
    }
  },
  "Resources": {
    {{ template "balancer-resources" . }}
    {{ template "service-resources" . }}
    {{ template "state" }}

    "LogGroup": {
      "Type": "AWS::Logs::LogGroup"
    },
    "Registry": {
      "Type": "AWS::ECR::Repository",
      "DeletionPolicy": "Retain"
    }
  }
}

{{ define "balancer-resources" }}
{{ end }}

{{ define "service-params" }}
  {{ range .Services }}
    "{{ upper .Name }}Formation": {
      "Type": "CommaDelimitedList",
      "Default": "0,128,256",
      "Description": "Count,CPU,Memory"
    },
  {{ end }}
{{ end }}

{{ define "service-resources" }}
  {{ range .Manifest.Services }}
    "{{ upper .Name }}Tasks": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            {{ with .Command }}
              "Command": [ "sh", "-c", "{{.}}" ],
            {{ end }}
            "Cpu": { "Fn::Select": [ 1, { "Ref": "{{ upper .Name }}Formation" } ] },
            "DockerLabels": { "convox.release": "{{$.Release.Id}}" },
            "Environment": [],
            "Image": { "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${Registry}:{{.Name}}.{{$.Release.Build}}" },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-region": { "Ref": "AWS::Region" },
                "awslogs-group": { "Ref": "LogGroup" },
                "awslogs-stream-prefix": "service"
              }
            },
            "Memory": { "Fn::Select": [ 2, { "Ref": "{{ upper .Name }}Formation" } ] },
            "Name": "{{.Name}}"
          }
        ],
        "Family": { "Fn::Sub": "${AWS::StackName}-{{.Name}}" }
      }
    },
    "{{ upper .Name }}Service": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": { "Fn::ImportValue": { "Fn::Sub": "${Rack}:Cluster" } },
        "DeploymentConfiguration": { "MinimumHealthyPercent": "100", "MaximumPercent": "200" },
        "DesiredCount": { "Fn::Select": [ 0, { "Ref": "{{ upper .Name }}Formation" } ] },
        "TaskDefinition": { "Ref": "{{ upper .Name }}Tasks" }
      }
    },
  {{ end }}
{{ end }}

{{ define "state" }}
  "Settings": {
    "Type": "AWS::S3::Bucket",
    "DeletionPolicy": "Retain",
    "Properties": {
      "AccessControl": "Private",
      "Tags": [
        { "Key": "system", "Value": "convox" },
        { "Key": "app", "Value": { "Ref": "AWS::StackName" } }
      ]
    }
  },
{{ end }}
