{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Conditions": {
    "Autoscale": { "Fn::Equals": [ { "Ref": "Autoscale" }, "Yes" ] },
    "BlankAmi": { "Fn::Equals": [ { "Ref": "Ami" }, "" ] },
    "BlankAvailabilityZones": { "Fn::Equals": [ { "Fn::Join": [ "", { "Ref": "AvailabilityZones" } ] }, "" ] },
    "BlankBuildImage": { "Fn::Equals": [ { "Ref": "BuildImage" }, "" ] },
    "BlankExistingVpc": { "Fn::Equals": [ { "Ref": "ExistingVpc" }, "" ] },
    "BlankExistingVpcAndThirdAvailabilityZone": {
      "Fn::And": [ { "Condition": "BlankExistingVpc" }, { "Condition": "ThirdAvailabilityZone" } ]
    },
    "BlankInstanceBootCommand": { "Fn::Equals": [ { "Ref": "InstanceBootCommand" }, "" ] },
    "BlankInstancePolicy": { "Fn::Equals": [ { "Ref": "InstancePolicy" }, "" ] },
    "BlankInstanceRunCommand": { "Fn::Equals": [ { "Ref": "InstanceRunCommand" }, "" ] },
    "BlankInstanceSecurityGroup": { "Fn::Equals": [ {"Ref": "InstanceSecurityGroup" }, "" ] },
    "BlankBuildInstanceSecurityGroup": { "Fn::Equals": [ {"Ref": "BuildInstanceSecurityGroup" }, "" ] },
    "BlankInternalSuffix": { "Fn::Equals": [ { "Ref": "InternalSuffix"}, "" ] },
    "BlankInternetGateway": { "Fn::Equals": [ { "Ref": "InternetGateway"}, "" ] },
    "BlankKey": { "Fn::Equals": [ { "Ref": "Key" }, "" ] },
    "BlankLogBucket": { "Fn::Equals": [ { "Ref": "LogBucket" }, "" ] },
    "BlankLogRetention": { "Fn::Equals": [ { "Ref": "LogRetention" }, "" ] },
    "BlankPrivateApiSecurityGroup": { "Fn::Equals": [ { "Ref": "PrivateApiSecurityGroup" }, "" ] },
    "BlankRouterSecurityGroup": { "Fn::Equals": [ { "Fn::Join": [ ",", { "Ref": "RouterSecurityGroup" } ] }, "" ] },
    "BlankRouterInternalSecurityGroup": { "Fn::Equals": [ { "Fn::Join": [ ",", { "Ref": "RouterInternalSecurityGroup" } ] }, "" ] },
    "BlankSslPolicy": { "Fn::Equals": [ { "Ref": "SslPolicy" }, "" ] },
    "CreateThirdPrivateSubnet": {"Fn::Or": [
      {"Condition": "PrivateApiAndThirdAvailabilityZoneAndHighAvailability"},
      {"Condition": "PrivateAndThirdAvailabilityZoneAndHighAvailability"}
    ]},
    "DedicatedBuilder": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "BuildInstance" }, "" ] } ] },
    "Development": { "Fn::Equals": [ { "Ref": "Development" }, "Yes" ] },
    "EnableCloudWatch": { "Fn::Equals": [ { "Ref": "LogDriver" }, "CloudWatch" ] },
    "EnableSyslog": { "Fn::Equals": [ { "Ref": "LogDriver" }, "Syslog" ] },
    "EncryptEbs" : { "Fn::Equals": [ { "Ref": "EncryptEbs" }, "Yes" ] },
    "ExistingVpc": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "ExistingVpc" }, "" ] } ] },
    "ExistingVpcAndBlankInternetGateway": {
      "Fn::And": [ { "Condition": "ExistingVpc" }, { "Condition": "BlankInternetGateway" } ]
    },
    "ExistingVpcAndInternetGateway": {
      "Fn::And": [ { "Condition": "ExistingVpc" }, { "Condition": "InternetGateway" } ]
    },
    "HighAvailability": { "Fn::Equals": [ { "Ref": "HighAvailability" }, "true" ] },
    "HttpProxy": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "HttpProxy" }, "" ] } ] },
    "InstanceARM": {
      "Fn::Or": [
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                0,
                { "Fn::Split": ["a1", { "Ref": "InstanceType" }] }
              ]
            },
            ""
          ]
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                0,
                { "Fn::Split": ["r6g", { "Ref": "InstanceType" }] }
              ]
            },
            ""
          ]
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                0,
                { "Fn::Split": ["m6g", { "Ref": "InstanceType" }] }
              ]
            },
            ""
          ]
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                0,
                { "Fn::Split": ["c6g", { "Ref": "InstanceType" }] }
              ]
            },
            ""
          ]
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                0,
                { "Fn::Split": ["c7g", { "Ref": "InstanceType" }] }
              ]
            },
            ""
          ]
        },
        {
          "Fn::Equals": [
            {
              "Fn::Select": [
                0,
                { "Fn::Split": ["t4g", { "Ref": "InstanceType" }] }
              ]
            },
            ""
          ]
        }
      ]
    },
    "Internal": { "Fn::Equals": [ { "Ref": "Internal" }, "Yes" ] },
    "InternetGateway": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "InternetGateway" }, "" ] } ] },
    "NotExistingVpcAndBlankInternetGateway": { "Fn::Not": [ { "Condition": "ExistingVpcAndBlankInternetGateway" } ] },
    "Private": { "Fn::Or": [ { "Condition": "PrivateBuild" }, { "Condition": "PrivateInstances" } ] },
    "PrivateAndThirdAvailabilityZoneAndHighAvailability": {
      "Fn::And": [ { "Condition": "Private" }, { "Condition": "ThirdAvailabilityZone" }, { "Condition": "HighAvailability" } ]
    },
    "PrivateApi": { "Fn::Equals": [ { "Ref": "PrivateApi" }, "Yes" ] },
    "PrivateApiAndThirdAvailabilityZoneAndHighAvailability": {
      "Fn::And": [ { "Condition": "PrivateApi" }, { "Condition": "ThirdAvailabilityZone" }, { "Condition": "HighAvailability" } ]
    },
    "PrivateBuild": { "Fn::Or": [ { "Fn::Equals": [ { "Ref": "Private" }, "Yes" ] }, { "Fn::Equals": [ { "Ref": "PrivateBuild" }, "Yes" ] } ] },
    "PrivateInstances": { "Fn::Equals": [ { "Ref": "Private" }, "Yes" ] },
    "PublicRouter": { "Fn::Equals": [ { "Ref": "InternalOnly" }, "No" ] },
    "RegionHasEFS": { "Fn::Equals": [
      { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "EFS" ] },
      "Yes"
    ] },
    "RegionHasEFSAndThirdAvailabilityZoneAndHighAvailability": {
      "Fn::And": [ { "Condition": "RegionHasEFS" }, { "Condition": "ThirdAvailabilityZone" }, { "Condition": "HighAvailability" } ]
    },
    "SetScheduleRackScale": { "Fn::Not" : [{
      "Fn::And": [
        { "Fn::Equals": [ { "Ref": "ScheduleRackScaleDown" }, "" ] },
        { "Fn::Equals": [ { "Ref": "ScheduleRackScaleUp" }, "" ] }
      ]}
    ] },
    "SpotInstances": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "SpotInstanceBid"}, "" ] } ] },
    "SpotInstancesAndHA": { "Fn::And": [ { "Condition": "SpotInstances" }, { "Condition": "HighAvailability" } ] },
    "SpotInstancesAndSetScheduleRack": { "Fn::And": [ { "Condition": "SpotInstances" }, { "Condition": "SetScheduleRackScale" } ] },
    "SwapEnabled": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "SwapSize" }, "0" ] } ] },
    "ThirdAvailabilityZone": { "Fn::And": [
      { "Fn::Equals": [ { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "ThirdAvailabilityZone" ] }, "Yes" ] },
      { "Fn::Equals": [ { "Ref": "MaxAvailabilityZones" }, "3" ] }
    ] },
    "ThirdAvailabilityZoneAndHighAvailability": { "Fn::And": [
      { "Condition": "HighAvailability"},
      { "Condition": "ThirdAvailabilityZone"}
    ] },
    "ThirdAvailabilityZoneAndNotExistingVpcAndBlankInternetGatewayAndHighAvailability": {
      "Fn::And": [
        { "Condition": "HighAvailability" },
        { "Condition": "NotExistingVpcAndBlankInternetGateway" },
        { "Condition": "ThirdAvailabilityZone" }
      ]
    }
  },
  "Mappings": {
    "RegionConfig": {
      "af-south-1":     { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "098369216593", "Fargate": "Yes" },
      "ap-east-1":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "754344448648", "Fargate": "Yes" },
      "ap-northeast-1": { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "582318560864", "Fargate": "No"  },
      "ap-northeast-2": { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "600734575887", "Fargate": "Yes" },
      "ap-northeast-3": { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "383597477331", "Fargate": "Yes" },
      "ap-south-1":     { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "718504428378", "Fargate": "Yes" },
      "ap-southeast-1": { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "114774131450", "Fargate": "Yes" },
      "ap-southeast-2": { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "783225319266", "Fargate": "Yes" },
      "ca-central-1":   { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "985666609251", "Fargate": "No"  },
      "eu-central-1":   { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "054676820928", "Fargate": "Yes" },
      "eu-north-1":     { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "897822967062", "Fargate": "Yes" },
      "eu-south-1":     { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "635631232127", "Fargate": "Yes" },
      "eu-west-1":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "156460612806", "Fargate": "Yes" },
      "eu-west-2":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "652711504416", "Fargate": "Yes" },
      "eu-west-3":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "009996457667", "Fargate": "Yes" },
      "me-south-1":     { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "076674570225", "Fargate": "Yes" },
      "sa-east-1":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "507241528517", "Fargate": "Yes" },
      "us-east-1":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "127311923021", "Fargate": "Yes" },
      "us-east-2":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "033677994240", "Fargate": "Yes" },
      "us-west-1":      { "EFS": "Yes", "ThirdAvailabilityZone": "No",  "ELBAccountId": "027434742980", "Fargate": "No"  },
      "us-west-2":      { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "797873946194", "Fargate": "Yes" },
      "us-gov-east-1":  { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "190560391635", "Fargate": "Yes" },
      "us-gov-west-1":  { "EFS": "Yes", "ThirdAvailabilityZone": "Yes", "ELBAccountId": "048591011584", "Fargate": "Yes" }
    }
  },
  "Outputs": {
    "AutoscalingGroup": {
      "Value": { "Ref": "Instances" }
    },
    "AvailabilityZones": {
      "Value": { "Fn::If": [ "BlankAvailabilityZones",
        { "Fn::Join": [ ",", [
          { "Fn::Select": [ 0, { "Fn::GetAZs": "" } ] },
          { "Fn::Select": [ 1, { "Fn::GetAZs": "" } ] },
          { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability",
            { "Fn::Select": [ 2, { "Fn::GetAZs": "" } ] },
            { "Ref": "AWS::NoValue" }
          ] }
        ] ] },
        { "Fn::Join": [ ",", [
          { "Fn::Select": [ 0, { "Ref": "AvailabilityZones" } ] },
          { "Fn::Select": [ 1, { "Ref": "AvailabilityZones" } ] },
          { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability",
            { "Fn::Select": [ 2, { "Ref": "AvailabilityZones" } ] },
            { "Ref": "AWS::NoValue" }
          ] }
        ] ] }
      ] }
    },
    "AwsRegion": {
      "Value": { "Ref": "AWS::Region" }
    },
    "BuildAutoscalingGroup": {
      "Value": { "Fn::If": [ "DedicatedBuilder", { "Ref": "BuildInstances" }, { "Ref": "Instances" } ] }
    },
    "BuildCluster": {
      "Value": { "Fn::If": [ "DedicatedBuilder", { "Ref": "BuildCluster" }, { "Ref": "Cluster" } ] }
    },
    "Cluster": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:Cluster" } },
      "Value": { "Ref": "Cluster" }
    },
    "CustomTopic": {
      "Value": { "Fn::GetAtt": [ "CustomTopic", "Arn" ] }
    },
    "CustomerManagedKey": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:CustomerManagedKey" } },
      "Value": { "Ref": "CustomerManagedKey" }
    },
    "CMKPolicy": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:CMKPolicy" } },
      "Value": { "Ref": "CMKPolicy" }
    },
    "Dashboard": {
      "Value": { "Fn::Join": [ ".", [
        "rack",
        { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
        { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
        "convox.site"
      ] ] }
    },
    "Domain": {
      "Condition": "PublicRouter",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:Domain" } },
      "Value": { "Fn::GetAtt": [ "Router", "DNSName" ] }
    },
    "DomainInternal": {
      "Condition": "Internal",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:DomainInternal" } },
      "Value": { "Fn::GetAtt": [ "RouterInternal", "DNSName" ] }
    },
    "DynamoBuilds": {
      "Value": { "Ref": "DynamoBuilds" }
    },
    "DynamoReleases": {
      "Value": { "Ref": "DynamoReleases" }
    },
    "EcsPollInterval": {
      "Value": { "Ref": "EcsPollInterval" }
    },
    "EncryptionKey": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:EncryptionKey" } },
      "Value": { "Ref": "EncryptionKey" }
    },
    "Fargate": {
      "Value": { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "Fargate" ] }
    },
    "Gateway": {
      "Condition": "BlankExistingVpc",
      "Value": { "Ref": "Gateway" }
    },
    "GatewayAttachment": {
      "Condition": "BlankExistingVpc",
      "Value": { "Ref": "GatewayAttachment" }
    },
    "HostedZone": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:HostedZone" } },
      "Value": { "Ref": "HostedZone" }
    },
    "InstancesRole": {
      "Value": { "Fn::GetAtt": [ "InstancesRole", "Arn" ] }
    },
    "InstancesSecurityGroup": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:InstancesSecurityGroup" } },
      "Value": { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] }
    },
    "BuildInstancesSecurityGroup": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:BuildInstancesSecurityGroup" } },
      "Value": { "Fn::If": [ "BlankBuildInstanceSecurityGroup",
        { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] },
        { "Ref": "BuildInstanceSecurityGroup" }
      ] }
    },
    "Internal": {
      "Value": { "Ref": "Internal" }
    },
    "ELBLogBucket": {
      "Value": { "Fn::If": [ "BlankLogBucket", { "Ref": "ELBLogs" }, { "Ref": "LogBucket" } ] }
    },
    "LogBucket": {
      "Value": { "Fn::If": [ "BlankLogBucket", { "Ref": "Logs" }, { "Ref": "LogBucket" } ] }
    },
    "LogDriver": {
      "Value": { "Ref": "LogDriver" }
    },
    "LogGroup": {
      "Condition": "EnableCloudWatch",
      "Value": { "Ref": "LogGroup" }
    },
    "NatGateways": {
      "Value": {
        "Fn::If": [
          "Private",
          { "Fn::Join": [
            ",",
            [
              { "Ref": "Nat0" },
              { "Ref": "Nat1" },
              { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Nat2" }, { "Ref": "AWS::NoValue" } ] }
            ]
          ]},
          ""
        ]
      }
    },
    "NatIPs": {
      "Value": {
        "Fn::If": [
          "Private",
          { "Fn::Join": [
            ",",
            [
              { "Ref": "NatAddress0" },
              { "Ref": "NatAddress1" },
              { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "NatAddress2" }, { "Ref": "AWS::NoValue" } ] }
            ]
          ]},
          ""
        ]
      }
    },
    "NotificationTopic": {
      "Value" : { "Ref": "NotificationTopic" }
    },
    "OnDemandMinCount": {
      "Value": { "Ref": "OnDemandMinCount" }
    },
    "Password": {
      "Condition": "Development",
      "Value": { "Ref": "Password" }
    },
    "Private": {
      "Value": { "Ref": "Private" }
    },
    "Rack": {
      "Value": { "Ref": "AWS::StackName" }
    },
    "RouterCertificate": {
      "Condition": "PublicRouter",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterCertificate" } },
      "Value": { "Ref": "RouterApiCertificate" }
    },
    "RouterHost": {
      "Condition": "PublicRouter",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterHost" } },
      "Value": { "Fn::Join": [ ".", [
        { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "Router", "DNSName" ] } ] } ] },
        { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "Router", "DNSName" ] } ] } ] },
        "convox.site"
      ] ] }
    },
    "RouterListener80": {
      "Condition": "PublicRouter",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterListener80" } },
      "Value": { "Ref": "RouterListener80" }
    },
    "RouterListener443": {
      "Condition": "PublicRouter",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterListener443" } },
      "Value": { "Ref": "RouterListener443" }
    },
    "RouterName": {
      "Condition": "PublicRouter",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterName" } },
      "Value": { "Fn::GetAtt": [ "Router", "LoadBalancerFullName" ] }
    },
    "RouterInternalCertificate": {
      "Condition": "Internal",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterInternalCertificate" } },
      "Value": { "Ref": "RouterInternalCertificate" }
    },
    "RouterInternalHost": {
      "Condition": "Internal",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterInternalHost" } },
      "Value": { "Fn::Join": [ ".", [
        { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "RouterInternal", "DNSName" ] } ] } ] },
        { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "RouterInternal", "DNSName" ] } ] } ] },
        "convox.site"
      ] ] }
    },
    "RouterInternalListener80": {
      "Condition": "Internal",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterInternalListener80" } },
      "Value": { "Ref": "RouterInternalListener80" }
    },
    "RouterInternalListener443": {
      "Condition": "Internal",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterInternalListener443" } },
      "Value": { "Ref": "RouterInternalListener443" }
    },
    "RouterInternalName": {
      "Condition": "Internal",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterInternalName" } },
      "Value": { "Fn::GetAtt": [ "RouterInternal", "LoadBalancerFullName" ] }
    },
    "RouterInternalSecurityGroup": {
      "Condition": "Internal",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterInternalSecurityGroup" } },
      "Value": { "Fn::If": [ "BlankRouterInternalSecurityGroup", { "Ref": "RouterInternalSecurity" }, { "Fn::Select": [ 0, { "Ref": "RouterInternalSecurityGroup" } ] } ] }
    },
    "RouterSecurityGroup": {
      "Condition": "PublicRouter",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:RouterSecurityGroup" } },
      "Value": { "Fn::If": [ "BlankRouterSecurityGroup", { "Ref": "RouterSecurity" }, { "Fn::Select": [ 0, { "Ref": "RouterSecurityGroup" } ] } ] }
    },
    "RouteTablePublic": {
      "Condition": "NotExistingVpcAndBlankInternetGateway",
      "Value": { "Ref": "Routes" }
    },
    "RouteTablesPrivate": {
      "Value": { "Fn::If": [ "Private",
        { "Fn::Join": [ ",", [ { "Ref": "RouteTablePrivate0" }, { "Ref": "RouteTablePrivate1" }, { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "RouteTablePrivate2" }, { "Ref": "AWS::NoValue" } ] } ] ] },
        ""
      ] }
    },
    "ServiceRole": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:ServiceRole" } },
      "Value": { "Fn::GetAtt": [ "ServiceRole", "Arn" ] }
    },
    "SettingsBucket": {
      "Value": { "Ref": "Settings" }
    },
    "SpotInstances": {
      "Value": { "Fn::If": [ "SpotInstances", "Yes", "No" ] }
    },
    "Subnets": {
      "Value": {
        "Fn::Join": [
          ",",
          [
            { "Ref": "Subnet0" },
            { "Ref": "Subnet1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
          ]
        ]
      }
    },
    "Subnet0": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:Subnet0" } },
      "Value": { "Ref": "Subnet0" }
    },
    "Subnet1": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:Subnet1" } },
      "Value": { "Ref": "Subnet1" }
    },
    "Subnet2": {
      "Condition": "ThirdAvailabilityZoneAndHighAvailability",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:Subnet2" } },
      "Value": { "Ref": "Subnet2" }
    },
    "SubnetsPrivate": {
      "Value": { "Fn::If":
        [ "Private",
          { "Fn::Join": [ ",",
            [
              { "Ref": "SubnetPrivate0" },
              { "Ref": "SubnetPrivate1" },
              { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
            ]
          ]},
          ""
        ]
      }
    },
    "SubnetPrivate0": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:SubnetPrivate0" } },
      "Value": { "Ref": "SubnetPrivate0" }
    },
    "SubnetPrivate1": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:SubnetPrivate1" } },
      "Value": { "Ref": "SubnetPrivate1" }
    },
    "SubnetPrivate2": {
      "Condition": "CreateThirdPrivateSubnet",
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:SubnetPrivate2" } },
      "Value": { "Ref": "SubnetPrivate2" }
    },
    "StackId": {
      "Value": { "Ref": "AWS::StackId" }
    },
    "SyslogDestination": {
      "Value": { "Ref": "SyslogDestination" }
    },
    "SyslogFormat": {
      "Value": { "Ref": "SyslogFormat" }
    },
    "Version": {
      "Value": { "Ref": "Version" }
    },
    "Vpc": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:Vpc" } },
      "Value": { "Fn::If": [ "BlankExistingVpc", { "Ref": "Vpc" }, { "Ref": "ExistingVpc" }] }
    },
    "Vpccidr": {
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}:VpcCidr" } },
      "Value": { "Ref": "VPCCIDR" }
    }
  },
  "Parameters": {
    "Ami": {
      "Type": "String",
      "Description": "Amazon Machine Image: http://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_container_instance.html",
      "Default": ""
    },
    "ApiCount": {
      "Type": "String",
      "Description": "The number of api web processes to run",
      "Default": "2"
    },
    "ApiCpu": {
      "Type": "String",
      "Description": "How much CPU should be reserved by the API web process.",
      "Default": "128"
    },
    "ApiMonitorMemory": {
      "Type": "String",
      "Description": "How much memory should be reserved by the api monitor process",
      "Default": "128"
    },
    "ApiRouter": {
      "Type": "String",
      "Description": "Defines ",
      "Default": "ELB",
      "AllowedValues": [ "ALB", "ELB" ]
    },
    "ApiWebMemory": {
      "Type": "String",
      "Description": "How much memory should be reserved by the api web process",
      "Default": "256"
    },
    "Autoscale": {
      "Type": "String",
      "Description": "Autoscale rack instances",
      "Default": "Yes",
      "AllowedValues": [ "Yes", "No" ]
    },
    "AutoscaleExtra": {
      "Type": "Number",
      "Description": "The number of instances of extra capacity that autoscale should keep running",
      "Default": "1"
    },
    "AvailabilityZones": {
      "Type": "CommaDelimitedList",
      "Description": "Override the availability zones used in the rack (specify 3)",
      "Default": ""
    },
    "BuildCpu": {
      "Type": "String",
      "Description": "How much cpu should be reserved by the builder",
      "Default": "256"
    },
    "BuildImage": {
      "Type": "String",
      "Description": "Override the default builder image",
      "Default": ""
    },
    "BuildInstance": {
      "Type": "String",
      "Description": "Instance type for a dedicated build cluster",
      "Default": "t3.small"
    },
    "BuildMemory": {
      "Type": "String",
      "Description": "How much memory should be reserved by the builder",
      "Default": "1000"
    },
    "BuildVolumeSize": {
      "Type": "Number",
      "Description": "Default build disk size in GB",
      "Default": "100"
    },
    "ClientId": {
      "Type": "String",
      "Description": "Anonymous identifier",
      "Default": ""
    },
    "DefaultAmi": {
      "Default": "/aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id",
      "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    },
    "DefaultAmiArm": {
      "Default": "/aws/service/ecs/optimized-ami/amazon-linux-2/arm64/recommended/image_id",
      "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    },
    "Development": {
      "Type": "String",
      "Description": "Development mode",
      "Default": "No",
      "AllowedValues": [ "Yes", "No" ]
    },
    "EcsPollInterval": {
      "Type": "Number",
      "Default": "1",
      "Description": "How often to poll ECS for service events in seconds. Longer intervals may alleviate rate limiting / throttling from ECS."
    },
    "EncryptEbs": {
      "Type": "String",
      "Description": "Enable encryption at rest for EBS volumes",
      "Default": "No",
      "AllowedValues": [ "Yes", "No" ]
    },
    "Encryption": {
      "Type": "String",
      "Description": "Encrypt secrets with KMS",
      "Default": "Yes",
      "AllowedValues": [ "Yes", "No" ]
    },
    "ExistingVpc": {
      "Description": "Existing VPC ID (if blank a VPC will be created)",
      "Type": "String",
      "Default": ""
    },
    "NoHaInstanceCount": {
      "Default": "1",
      "Description": "The number of instances in the runtime cluster for no HighAvailable racks",
      "MinValue": "1",
      "Type": "Number"
    },
    "HighAvailability": {
      "AllowedValues": [ "true", "false" ],
      "Default": "true",
      "Description": "Wether to create rack in High Availability mode.",
      "Type": "String"
    },
    "HttpProxy": {
      "Description": "Connect using an outbound HTTP proxy (for network-restricted Racks)",
      "Type": "String",
      "Default": ""
    },
    "ImagePullBehavior": {
      "Type": "String",
      "Description": "The behavior used to customize the pull image process for your container instances. See ECS_IMAGE_PULL_BEHAVIOR https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-agent-config.html",
      "Default": "default",
      "AllowedValues": ["default", "always", "once", "prefer-cached"]
    },
    "IMDSHttpTokens": {
      "Type": "String",
      "Description": "You can set EC2 instances to use only v2 by setting IMDSHttpTokens as 'required', see https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-options.html#configuring-IMDS-new-instances",
      "Default": "optional",
      "AllowedValues": [ "optional", "required" ]
    },
    "Internal": {
      "Type": "String",
      "Description": "Support applications that are only accessible inside the VPC",
      "Default": "No",
      "AllowedValues": [ "Yes", "No" ]
    },
    "InternalOnly": {
      "Type": "String",
      "Description": "Only support applications that are only accessible inside the VPC",
      "Default": "No",
      "AllowedValues": [ "Yes", "No" ]
    },
    "InternalSuffix": {
      "Type": "String",
      "Description": "Suffix for internal router",
      "Default": "-rti"
    },
    "InstanceBootCommand": {
      "Type": "String",
      "Description": "A single line of shell script to run as CloudInit command early during instance boot.",
      "Default": ""
    },
    "InstanceRunCommand": {
      "Type": "String",
      "Description": "A single line of shell script to run as CloudInit command late during instance boot.",
      "Default": ""
    },
    "InstanceCount": {
      "Default": "3",
      "Description": "The number of instances in the runtime cluster for high available racks",
      "MinValue": "3",
      "Type": "Number"
    },
    "InstanceType": {
      "Default": "t3.small",
      "Description": "The type of the instances in the runtime cluster",
      "Type": "String"
    },
    "InstanceUpdateBatchSize": {
      "Default": "1",
      "Description": "The number of instances to update in a batch",
      "MinValue": "1",
      "Type": "Number"
    },
    "InstancePolicy": {
      "Default": "",
      "Description": "ARN of an additional IAM policy to add to the cluster instances",
      "Type": "String"
    },
    "InstanceSecurityGroup": {
      "Default": "",
      "Description": "The security group to assign to the ECS instances.  If blank, convox will create a security group open to all IPs in your VPC",
      "Type": "String"
    },
    "BuildInstanceSecurityGroup": {
      "Default": "",
      "Description": "The security group to assign to the ECS build instances.  If blank, convox will use the same security group as the instances",
      "Type": "String"
    },
    "InternetGateway": {
      "Description": "The InternetGatway to route to if an Existing VPC is specified",
      "Type": "String",
      "Default": ""
    },
    "Key": {
      "Default": "",
      "Description": "SSH key name for access to cluster instances",
      "Type": "String"
    },
    "LoadBalancerIdleTimeout": {
      "Default": "3600",
      "Description": "The idle timeout value, in seconds. The valid range is 1-4000 seconds. The default is 3600 seconds.",
      "Type": "Number",
      "MaxValue": "4000",
      "MinValue": "1"
    },
    "LogBucket": {
      "Default": "",
      "Description": "Bucket to receive S3 logs",
      "Type": "String"
    },
    "LogDriver": {
      "Default": "CloudWatch",
      "Description": "Log driver used by the rack and services to send logs. Default to CloudWatch. You must provide the SyslogDestination when setting as Syslog. It disable logs if blank.",
      "Type": "String",
      "AllowedValues": [ "CloudWatch", "Syslog", ""]
    },
    "LogRetention": {
      "Default": "7",
      "Description": "Number of days to keep logs (blank for unlimited)",
      "Type": "String"
    },
    "MaxAvailabilityZones": {
      "Type": "Number",
      "Default": "3",
      "AllowedValues": [ "2", "3" ]
    },
    "OnDemandMinCount": {
      "Default": "3",
      "Description": "The minimum number of on-demand instances in the runtime cluster",
      "MinValue": "1",
      "Type": "Number"
    },
    "Password": {
      "Description": "(REQUIRED) API HTTP password",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "50",
      "NoEcho": true
    },
    "Private": {
      "Type": "String",
      "Description": "Create non publicly routable resources",
      "Default": "No",
      "AllowedValues": [ "Yes", "No" ]
    },
    "PrivateApi": {
      "Type": "String",
      "Description": "Put Rack API Load Balancer in private network",
      "Default": "No",
      "AllowedValues": [ "Yes", "No" ]
    },
    "PrivateApiSecurityGroup": {
      "Type": "String",
      "Description": "Lock down private API to a security group",
      "Default": ""
    },
    "PrivateBuild": {
      "Type": "String",
      "Description": "Place only the build instances into a private network (unused if Private is Yes)",
      "Default": "No",
      "AllowedValues": [ "Yes", "No" ]
    },
    "RouterInternalSecurityGroup": {
      "Default": "",
      "Description": "The security groups (comma delimited) to assign to the internal rack router.",
      "Type": "CommaDelimitedList"
    },
    "RouterMitigationMode": {
      "Default": "defensive",
      "Description": "Determines how the load balancer handles requests that might pose a security risk to your application.",
      "Type": "String",
      "AllowedValues": [ "defensive", "monitor", "strictest" ]
    },
    "RouterSecurityGroup": {
      "Default": "",
      "Description": "The security groups (comma delimited) to assign to the rack router.",
      "Type": "CommaDelimitedList"
    },
    "ScheduleRackScaleDown": {
      "Type": "String",
      "Description": "The recurring schedule for when the rack will be shutdown. This format consists of five fields separated by white spaces: [Minute] [Hour] [Day_of_Month] [Month_of_Year] [Day_of_Week]",
      "Default": ""
    },
    "ScheduleRackScaleUp": {
      "Type": "String",
      "Description": "The recurring schedule for when the rack will start. This format consists of five fields separated by white spaces: [Minute] [Hour] [Day_of_Month] [Month_of_Year] [Day_of_Week]",
      "Default": ""
    },
    "SpotInstanceBid": {
      "Default": "",
      "Description": "Bid price for spot instances",
      "Type": "String"
    },
    "SslPolicy": {
      "Default": "",
      "Description": "SSL policy for rack load balancer",
      "Type": "String"
    },
    "Subnet0CIDR": {
      "Default": "10.0.1.0/24",
      "Description": "Public Subnet 0 CIDR Block",
      "Type": "String"
    },
    "Subnet1CIDR": {
      "Default": "10.0.2.0/24",
      "Description": "Public Subnet 1 CIDR Block",
      "Type": "String"
    },
    "Subnet2CIDR": {
      "Default": "10.0.3.0/24",
      "Description": "Public Subnet 2 CIDR Block",
      "Type": "String"
    },
    "SubnetPrivate0CIDR": {
      "Default": "10.0.4.0/24",
      "Description": "Private Subnet 0 CIDR Block",
      "Type": "String"
    },
    "SubnetPrivate1CIDR": {
      "Default": "10.0.5.0/24",
      "Description": "Private Subnet 1 CIDR Block",
      "Type": "String"
    },
    "SubnetPrivate2CIDR": {
      "Default": "10.0.6.0/24",
      "Description": "Private Subnet 2 CIDR Block",
      "Type": "String"
    },
    "SwapSize": {
      "Type": "Number",
      "Description": "Default swap volume size in GB",
      "Default": "5"
    },
    "SyslogDestination": {
      "Type": "String",
      "Description": "Syslog address destination, you need to pass the protocol to be used, e.g. tcp+tls://logsX.syslog.com:1234",
      "Default": ""
    },
    "SyslogFormat": {
      "Type": "String",
      "Description": "Syslog format (low case) to sent to SyslogDestination.",
      "Default": "rfc5424"
    },
    "Version": {
      "Description": "(REQUIRED) Convox release version",
      "MinLength" : "1",
      "Type": "String"
    },
    "VolumeSize": {
      "Type": "Number",
      "Description": "Default disk size in GB",
      "Default": "50"
    },
    "VPCCIDR": {
      "Default": "10.0.0.0/16",
      "Description": "VPC CIDR Block",
      "Type": "String"
    },
    "Tenancy": {
      "Type": "String",
      "Description": "Dedicated Hardware",
      "Default": "default",
      "AllowedValues": [ "default", "dedicated" ]
    }
  },
  "Resources": {
    "DockertTLSCertGenerate": {
      "Type": "Custom::SelfSignedCertificate",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CustomTopic", "Arn" ] },
        "Description": "Create self signed certs for docker",
        "Rack": { "Ref": "AWS::StackName" }
      }
    },
    "DockertTLSCA": {
      "Type": "Custom::SelfSignedCertificateGetter",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CustomTopic", "Arn" ] },
        "Description": "Get tls ca cert docker",
        "Rack": { "Ref": "AWS::StackName" },
        "ParameterKey": { "Fn::GetAtt": [ "DockertTLSCertGenerate", "CACertSSMKey" ] }
      }
    },
    "DockertTLSCAKey": {
      "Type": "Custom::SelfSignedCertificateGetter",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CustomTopic", "Arn" ] },
        "Description": "Get tls ca key docker",
        "Rack": { "Ref": "AWS::StackName" },
        "ParameterKey": { "Fn::GetAtt": [ "DockertTLSCertGenerate", "CAKeySSMKey" ] }
      }
    },
    "DockertTLSCert": {
      "Type": "Custom::SelfSignedCertificateGetter",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CustomTopic", "Arn" ] },
        "Description": "Get tls cert for docker",
        "Rack": { "Ref": "AWS::StackName" },
        "ParameterKey": { "Fn::GetAtt": [ "DockertTLSCertGenerate", "CertSSMKey" ] }
      }
    },
    "DockertTLSKey": {
      "Type": "Custom::SelfSignedCertificateGetter",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CustomTopic", "Arn" ] },
        "Description": "Get tls key for docker",
        "Rack": { "Ref": "AWS::StackName" },
        "ParameterKey": { "Fn::GetAtt": [ "DockertTLSCertGenerate", "KeySSMKey" ] }
      }
    },
    "EncryptionKey": {
      "Type": "Custom::KMSKey",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CustomTopic", "Arn" ] },
        "Description": "Convox Master Encryption",
        "KeyUsage": "ENCRYPT_DECRYPT",
        "Rotate": "true"
      }
    },
    "EncryptionKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": { "Fn::Join": ["", ["alias/convox-", {"Ref":"AWS::StackName"} ]] },
        "TargetKeyId": { "Ref": "EncryptionKey" }
      }
    },
    "LogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "EnableCloudWatch",
      "Properties": {
        "RetentionInDays": { "Fn::If": [ "BlankLogRetention", { "Ref": "AWS::NoValue" }, { "Ref": "LogRetention" } ] }
      }
    },
    "CustomTopicRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": [ "lambda.amazonaws.com" ] },
              "Action": [ "sts:AssumeRole" ]
            }
          ]
        },
        "ManagedPolicyArns": [
          { "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole" },
          { "Ref": "CMKPolicy" }
        ],
        "Path": "/convox/",
        "Policies": [
          {
            "PolicyName": "Administrator",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                { "Effect": "Allow", "Action": "*", "Resource": "*" },
                { "Effect": "Deny", "Action": "s3:DeleteObject", "Resource": "*" }
              ]
            }
          }
        ]
      }
    },
    "NotificationTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName" : { "Fn::Join": ["", [{"Ref":"AWS::StackName"}, "-notifications"]] }
      }
    },
    "CustomTopic": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Fn::Join": [ "-", [ "convox", { "Ref": "AWS::Region" } ] ] },
          "S3Key": { "Fn::Join": [ "", [ "release/", { "Ref": "Version" }, "/lambda/formation.zip" ] ] }
        },
        "Description": "Convox handler for custom resources",
        "Handler": "index.external",
        "MemorySize": "128",
        "Role": { "Fn::GetAtt": [ "CustomTopicRole", "Arn" ] },
        "Runtime": "nodejs16.x",
        "Timeout": "300"
      }
    },
    "Vpc": {
      "Type": "AWS::EC2::VPC",
      "Condition": "BlankExistingVpc",
      "Properties": {
        "CidrBlock": { "Ref": "VPCCIDR" },
        "EnableDnsSupport": "true",
        "EnableDnsHostnames": "true",
        "InstanceTenancy": { "Ref": "Tenancy" },
        "Tags": [
          { "Key": "Name", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "Gateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Condition": "BlankExistingVpc",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "GatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Condition": "BlankExistingVpc",
      "Properties": {
        "InternetGatewayId": { "Ref": "Gateway" },
        "VpcId": { "Ref": "Vpc" }
      }
    },
    "ExistingGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Condition": "ExistingVpcAndInternetGateway",
      "DeletionPolicy": "Retain",
      "Properties": {
        "InternetGatewayId": { "Ref": "InternetGateway" },
        "VpcId": { "Ref": "ExistingVpc" }
      }
    },
    "Nat0": {
      "Condition": "Private",
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": { "Fn::GetAtt": [ "NatAddress0", "AllocationId" ] },
        "SubnetId": { "Ref": "Subnet0" }
      }
    },
    "Nat1": {
      "Condition": "Private",
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": { "Fn::GetAtt": [ "NatAddress1", "AllocationId" ] },
        "SubnetId": { "Ref": "Subnet1" }
      }
    },
    "Nat2": {
      "Condition": "PrivateAndThirdAvailabilityZoneAndHighAvailability",
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": { "Fn::GetAtt": [ "NatAddress2", "AllocationId" ] },
        "SubnetId": { "Ref": "Subnet2" }
      }
    },
    "NatAddress0": {
      "Condition": "Private",
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "NatAddress1": {
      "Condition": "Private",
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "NatAddress2": {
      "Condition": "PrivateAndThirdAvailabilityZoneAndHighAvailability",
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "SecureEnvironmentRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": [ "ecs-tasks.amazonaws.com" ] },
              "Action": [ "sts:AssumeRole" ]
            }
          ]
        },
        "ManagedPolicyArns": [
          { "Ref": "CMKPolicy" }
        ],
        "Path": "/convox/",
        "Policies": [
          {
            "PolicyName": "SecureEnvironmentPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": {
                "Effect": "Allow",
                "Action": [
                  "kms:Decrypt"
                ],
                "Resource": [
                  { "Ref": "EncryptionKey" }
                ]
              }
            }
          }
        ]
      }
    },
    "Subnet0": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ " ", [ { "Ref": "AWS::StackName" }, "public", "0" ] ] } }
        ],
        "AvailabilityZone": { "Fn::If": [ "BlankAvailabilityZones",
          { "Fn::Select": [ 0, { "Fn::GetAZs": "" } ] },
          { "Fn::Select": [ 0, { "Ref": "AvailabilityZones" } ] }
        ] },
        "CidrBlock": { "Ref": "Subnet0CIDR" },
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "Subnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ " ", [ { "Ref": "AWS::StackName" }, "public", "1" ] ] } }
        ],
        "AvailabilityZone": { "Fn::If": [ "BlankAvailabilityZones",
          { "Fn::Select": [ 1, { "Fn::GetAZs": "" } ] },
          { "Fn::Select": [ 1, { "Ref": "AvailabilityZones" } ] }
        ] },
        "CidrBlock": { "Ref": "Subnet1CIDR" },
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "Subnet2": {
      "Condition": "ThirdAvailabilityZoneAndHighAvailability",
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Join": [ " ", [ { "Ref": "AWS::StackName" }, "public", "2" ] ] } }
        ],
        "AvailabilityZone": { "Fn::If": [ "BlankAvailabilityZones",
          { "Fn::Select": [ 2, { "Fn::GetAZs": "" } ] },
          { "Fn::Select": [ 2, { "Ref": "AvailabilityZones" } ] }
        ] },
        "CidrBlock": { "Ref": "Subnet2CIDR" },
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "SubnetPrivate0": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "Tags": [ { "Key": "Name", "Value": { "Fn::Join": [ " ", [ { "Ref": "AWS::StackName" }, "private", "0" ] ] } } ],
        "AvailabilityZone": { "Fn::If": [ "BlankAvailabilityZones",
          { "Fn::Select": [ 0, { "Fn::GetAZs": "" } ] },
          { "Fn::Select": [ 0, { "Ref": "AvailabilityZones" } ] }
        ] },
        "CidrBlock": { "Ref": "SubnetPrivate0CIDR" },
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "SubnetPrivate1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "Tags": [ { "Key": "Name", "Value": { "Fn::Join": [ " ", [ { "Ref": "AWS::StackName" }, "private", "1" ] ] } } ],
        "AvailabilityZone": { "Fn::If": [ "BlankAvailabilityZones",
          { "Fn::Select": [ 1, { "Fn::GetAZs": "" } ] },
          { "Fn::Select": [ 1, { "Ref": "AvailabilityZones" } ] }
        ] },
        "CidrBlock": { "Ref": "SubnetPrivate1CIDR" },
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "SubnetPrivate2": {
      "Condition": "CreateThirdPrivateSubnet",
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "Tags": [ { "Key": "Name", "Value": { "Fn::Join": [ " ", [ { "Ref": "AWS::StackName" }, "private", "2" ] ] } } ],
        "AvailabilityZone": { "Fn::If": [ "BlankAvailabilityZones",
          { "Fn::Select": [ 2, { "Fn::GetAZs": "" } ] },
          { "Fn::Select": [ 2, { "Ref": "AvailabilityZones" } ] }
        ] },
        "CidrBlock": { "Ref": "SubnetPrivate2CIDR" },
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "Routes": {
      "Type": "AWS::EC2::RouteTable",
      "Condition": "NotExistingVpcAndBlankInternetGateway",
      "Properties": {
        "Tags": [
          { "Key": "GatewayAttachment", "Value": { "Fn::If": [ "BlankExistingVpc", { "Ref": "GatewayAttachment" }, "existing" ] } },
          { "Key": "Name", "Value": { "Ref": "AWS::StackName" } }
        ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "RouteDefault": {
      "Type": "AWS::EC2::Route",
      "Condition": "NotExistingVpcAndBlankInternetGateway",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": { "Fn::If": [ "ExistingVpcAndInternetGateway",
          { "Ref": "InternetGateway" },
          { "Ref": "Gateway" }
        ] },
        "RouteTableId": { "Ref": "Routes" }
      }
    },
    "RouteTablePrivate0": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Ref": "AWS::StackName" } }
        ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "RouteTablePrivate1": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Ref": "AWS::StackName" } }
        ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "RouteTablePrivate2": {
      "Condition": "PrivateAndThirdAvailabilityZoneAndHighAvailability",
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Ref": "AWS::StackName" } }
        ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "RouteDefaultPrivate0": {
      "Condition": "Private",
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": { "Ref": "Nat0" },
        "RouteTableId": { "Ref": "RouteTablePrivate0" }
      }
    },
    "RouteDefaultPrivate1": {
      "Condition": "Private",
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": { "Ref": "Nat1" },
        "RouteTableId": { "Ref": "RouteTablePrivate1" }
      }
    },
    "RouteDefaultPrivate2": {
      "Condition": "PrivateAndThirdAvailabilityZoneAndHighAvailability",
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": { "Ref": "Nat2" },
        "RouteTableId": { "Ref": "RouteTablePrivate2" }
      }
    },
    "Subnet0Routes": {
      "Condition": "NotExistingVpcAndBlankInternetGateway",
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "Subnet0" },
        "RouteTableId": { "Ref": "Routes" }
      }
    },
    "Subnet1Routes": {
      "Condition": "NotExistingVpcAndBlankInternetGateway",
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "Subnet1" },
        "RouteTableId": { "Ref": "Routes" }
      }
    },
    "Subnet2Routes": {
      "Condition": "ThirdAvailabilityZoneAndNotExistingVpcAndBlankInternetGatewayAndHighAvailability",
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "Subnet2" },
        "RouteTableId": { "Ref": "Routes" }
      }
    },
    "SubnetPrivate0Routes": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "SubnetPrivate0" },
        "RouteTableId": { "Ref": "RouteTablePrivate0" }
      }
    },
    "SubnetPrivate1Routes": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "SubnetPrivate1" },
        "RouteTableId": { "Ref": "RouteTablePrivate1" }
      }
    },
    "SubnetPrivate2Routes": {
      "Condition": "PrivateAndThirdAvailabilityZoneAndHighAvailability",
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "SubnetPrivate2" },
        "RouteTableId": { "Ref": "RouteTablePrivate2" }
      }
    },
    "HostedZone": {
      "Type": "AWS::Route53::HostedZone",
      "Properties": {
        "Name": { "Fn::Sub": "${AWS::StackName}.convox" },
        "VPCs": [ { "VPCId": { "Fn::If": [ "BlankExistingVpc", { "Ref": "Vpc" }, { "Ref": "ExistingVpc" } ] }, "VPCRegion": { "Ref": "AWS::Region" } } ]
      }
    },
    "RecordSetGateway": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": { "Ref": "HostedZone" },
        "Name": { "Fn::Sub": "host.${AWS::StackName}.convox." },
        "Type": "A",
        "TTL": "3600",
        "ResourceRecords": [ "172.17.0.1" ]
      }
    },
    "RecordSetRack": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": { "Ref": "HostedZone" },
        "Name": { "Fn::Sub": "rack.${AWS::StackName}.convox." },
        "Type": "CNAME",
        "TTL": "3600",
        "ResourceRecords": [
          { "Fn::Join": [ ".", [
            "rack",
            { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
            { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
            "convox.site"
          ] ] }
        ]
      }
    },
    "InstancesSecurity": {
      "DependsOn": "ApiRole",
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": { "Fn::Sub": "${AWS::StackName} instances" },
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": "0", "ToPort": "65535", "CidrIp": { "Ref": "VPCCIDR" } },
          { "IpProtocol": "udp", "FromPort": "0", "ToPort": "65535", "CidrIp": { "Ref": "VPCCIDR" } }
        ],
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "${AWS::StackName}-instances" } }
        ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc",
          { "Ref": "Vpc" },
          { "Ref": "ExistingVpc" }
        ] }
      }
    },
    "InstancesRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [ { "Effect": "Allow", "Principal": { "Service": [ "ec2.amazonaws.com" ] }, "Action": [ "sts:AssumeRole" ] } ],
          "Version": "2012-10-17"
        },
        "Path": "/convox/",
        "ManagedPolicyArns": [
          { "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role" },
          { "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AutoScalingFullAccess" },
          { "Ref": "CMKPolicy" },
          { "Fn::If": [ "BlankInstancePolicy",
            { "Ref": "AWS::NoValue" },
            { "Ref": "InstancePolicy" }
          ] }
        ]
      }
    },
    "InstancesProfile": {
      "DependsOn": "ApiRole",
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/convox/",
        "Roles": [ { "Ref": "InstancesRole" } ]
      }
    },
    "BuildCluster": {
      "Condition": "DedicatedBuilder",
      "Type": "AWS::ECS::Cluster"
    },
    "BuildLaunchConfiguration": {
      "Condition": "DedicatedBuilder",
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "AssociatePublicIpAddress": { "Fn::If": [ "PrivateBuild", false, true ] },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "Encrypted": { "Fn::If": [ "EncryptEbs", "true", { "Ref": "AWS::NoValue" } ] },
              "VolumeSize": { "Ref": "BuildVolumeSize" },
              "VolumeType":"gp3"
            }
          },
          { "Fn::If": [ "SwapEnabled",
            {
              "DeviceName": "/dev/xvdb",
              "Ebs": {
                "Encrypted": { "Fn::If": [ "EncryptEbs", "true", { "Ref": "AWS::NoValue" } ] },
                "VolumeSize": { "Ref": "SwapSize" },
                "VolumeType":"gp3"
              }
            },
            { "Ref": "AWS::NoValue" }
          ] }
        ],
        "IamInstanceProfile": { "Ref": "InstancesProfile" },
        "ImageId": {
          "Fn::If": [
            "BlankAmi",
            {
              "Fn::If": [
                "InstanceARM",
                {
                  "Ref": "DefaultAmiArm"
                },
                {
                  "Ref": "DefaultAmi"
                }
              ]
            },
            { "Ref": "Ami" }
          ]
        },
        "InstanceMonitoring": true,
        "InstanceType": { "Ref": "BuildInstance" },
        "KeyName": { "Fn::If": [ "BlankKey", { "Ref": "AWS::NoValue" }, { "Ref": "Key" } ] },
        "MetadataOptions" : {
          "HttpEndpoint" : "enabled",
          "HttpTokens" : { "Ref": "IMDSHttpTokens"}
        },
        "PlacementTenancy" : { "Ref": "Tenancy" },
        "SecurityGroups": [ { "Fn::If": [ "BlankBuildInstanceSecurityGroup",
          { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] },
          { "Ref": "BuildInstanceSecurityGroup" }
        ] } ],
        "UserData": { "Fn::Base64":
          { "Fn::Join": [ "", [
            "#cloud-config\n",
            "repo_upgrade_exclude:\n",
            "  - kernel*\n",
            "packages:\n",
            "  - aws-cfn-bootstrap\n",
            "mounts:\n",
            { "Fn::If": [ "SwapEnabled",
              "  - ['/dev/xvdb', 'none', 'swap', 'sw', '0', '0']\n",
              { "Ref": "AWS::NoValue" }
            ] },
            "bootcmd:\n",
            { "Fn::If": [ "SwapEnabled",
              { "Fn::Join": [ "", [
                "  - mkswap /dev/xvdb\n",
                "  - swapon /dev/xvdb\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - export http_proxy=", { "Ref": "HttpProxy" }, "\n",
            "  - echo http_proxy=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export https_proxy=", { "Ref": "HttpProxy" }, "\n",
            "  - echo https_proxy=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export HTTP_PROXY=", { "Ref": "HttpProxy" }, "\n",
            "  - echo HTTP_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export HTTPS_PROXY=", { "Ref": "HttpProxy" }, "\n",
            "  - echo HTTPS_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export NO_PROXY=169.254.169.254\n",
            "  - echo NO_PROXY=169.254.169.254 >> /etc/environment\n",
            { "Fn::If": [ "HttpProxy",
              { "Fn::Join": ["", ["  - echo \"proxy=http://", { "Ref": "HttpProxy" }, "/\" >> /etc/yum.conf\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - echo ECS_CLUSTER=", { "Ref": "BuildCluster" }, " >> /etc/ecs/ecs.config\n",
            "  - echo ECS_IMAGE_PULL_BEHAVIOR=", { "Ref": "ImagePullBehavior" }, " >> /etc/ecs/ecs.config\n",
            "  - echo ECS_ENGINE_AUTH_TYPE=docker >> /etc/ecs/ecs.config\n",
            "  - echo 'ECS_INSTANCE_ATTRIBUTES={\"asg\":\"build\"}' >> /etc/ecs/ecs.config\n",
            "  - echo HTTP_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/ecs/ecs.config\n",
            "  - echo NO_PROXY=169.254.169.254,169.254.170.2,/var/run/docker.sock >> /etc/ecs/ecs.config\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSCA", "Value" ] }, "' | base64 -d > /etc/ca.pem\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSCert", "Value" ] }, "' | base64 -d > /etc/cert.pem\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSKey", "Value" ] }, "' | base64 -d > /etc/key.pem\n",
            "  - echo 'OPTIONS=\"--default-ulimit nofile=1024000:1024000 --log-opt max-file=2 --log-opt max-size=50m --host=unix:///var/run/docker.sock --host=0.0.0.0:2376 --tls --tlscacert /etc/ca.pem --tlscert /etc/cert.pem --tlskey /etc/key.pem\"' >> /etc/sysconfig/docker\n",
            "  - echo 'ECS_ENGINE_AUTH_DATA={\"index.docker.io\":{\"username\":\"\",\"password\":\"\",\"email\":\"\"}' >> /etc/ecs/ecs.config\n",
            "  - echo 'docker image prune -a --filter=\"until=96h\" --force' > /etc/cron.daily/docker-prune\n",
            "  - chmod +x /etc/cron.daily/docker-prune\n",
            "  - echo 'docker builder prune -a --filter=\"until=96h\" --force' > /etc/cron.daily/docker-builder-prune\n",
            "  - chmod +x /etc/cron.daily/docker-builder-prune\n",
            { "Fn::If": [ "HttpProxy",
              { "Fn::Join": ["", ["  - echo \"export HTTP_PROXY=", { "Ref": "HttpProxy" }, "/\" >> /etc/sysconfig/docker\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - echo -e '/var/log/docker {\\n  rotate 7\\n  daily\\n  nocompress\\n  copytruncate\\n}' >> /etc/logrotate.d/docker\n",
            { "Fn::If": [ "BlankInstanceBootCommand",
              { "Ref": "AWS::NoValue" },
              { "Fn::Join": [ "", [
              "  - ", { "Ref": "InstanceBootCommand" }, "\n"
              ] ] }
            ] },
            "runcmd:\n",
            { "Fn::If": [ "BlankInstanceRunCommand",
              { "Ref": "AWS::NoValue" },
              { "Fn::Join": [ "", [
              "  - ", { "Ref": "InstanceRunCommand" }, "\n"
              ] ] }
            ] },
            "  - /opt/aws/bin/cfn-signal --http-proxy \"", { "Ref": "HttpProxy" }, "\" --stack ", { "Ref": "AWS::StackName" }, " --region ", { "Ref":"AWS::Region" }, " --resource BuildInstances\n"
          ] ] }
        }
      }
    },
    "BuildInstances": {
      "Condition": "DedicatedBuilder",
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "LaunchConfigurationName" : { "Ref": "BuildLaunchConfiguration" },
        "VPCZoneIdentifier": {
          "Fn::If": [ "PrivateBuild", [
            { "Ref": "SubnetPrivate0" },
            { "Ref": "SubnetPrivate1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
          ], [
            { "Ref": "Subnet0" },
            { "Ref": "Subnet1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
          ] ]
        },
        "Cooldown": 5,
        "DesiredCapacity": "1",
        "HealthCheckType": "EC2",
        "HealthCheckGracePeriod": "120",
        "MinSize" : "1",
        "MaxSize" : "2",
        "MetricsCollection": [ { "Granularity": "1Minute" } ],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Ref": "AWS::StackName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Rack",
            "Value": { "Ref": "AWS::StackName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "GatewayAttachment",
            "Value": { "Fn::If": [ "ExistingVpc", "existing", { "Ref": "GatewayAttachment" } ] },
            "PropagateAtLaunch": false
          },
          {
            "Key": "NatGateways",
            "PropagateAtLaunch": false,
            "Value": { "Fn::If": [
              "PrivateBuild",
              { "Fn::Join": [ ",", [
                { "Ref": "Nat0" },
                { "Ref": "Nat1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Nat2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] },
              ""
            ] }
          }
        ]
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": { "Ref": "InstanceUpdateBatchSize" },
          "MinInstancesInService": "1",
          "PauseTime" : "PT5M",
          "SuspendProcesses": [
            "ScheduledActions"
          ],
          "WaitOnResourceSignals": "true"
        }
      }
    },
    "LaunchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "AssociatePublicIpAddress": { "Fn::If": [ "PrivateInstances", false, true ] },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "Encrypted": { "Fn::If": [ "EncryptEbs", "true", { "Ref": "AWS::NoValue" } ] },
              "VolumeSize": { "Ref": "VolumeSize" },
              "VolumeType":"gp3"
            }
          },
          { "Fn::If": [ "SwapEnabled",
            {
              "DeviceName": "/dev/xvdb",
              "Ebs": {
                "Encrypted": { "Fn::If": [ "EncryptEbs", "true", { "Ref": "AWS::NoValue" } ] },
                "VolumeSize": { "Ref": "SwapSize" },
                "VolumeType":"gp3"
              }
            },
            { "Ref": "AWS::NoValue" }
          ] }
        ],
        "IamInstanceProfile": { "Ref": "InstancesProfile" },
        "ImageId": {
          "Fn::If": [
            "BlankAmi",
            {
              "Fn::If": [
                "InstanceARM",
                {
                  "Ref": "DefaultAmiArm"
                },
                {
                  "Ref": "DefaultAmi"
                }
              ]
            },
            { "Ref": "Ami" }
          ]
        },
        "InstanceMonitoring": true,
        "InstanceType": { "Ref": "InstanceType" },
        "KeyName": { "Fn::If": [ "BlankKey", { "Ref": "AWS::NoValue" }, { "Ref": "Key" } ] },
        "MetadataOptions" : {
          "HttpEndpoint" : "enabled",
          "HttpTokens" : { "Ref": "IMDSHttpTokens"}
        },
        "PlacementTenancy" : { "Ref": "Tenancy" },
        "SecurityGroups": [ { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] } ],
        "UserData": { "Fn::Base64":
          { "Fn::Join": [ "", [
            "#cloud-config\n",
            "repo_upgrade_exclude:\n",
            "  - kernel*\n",
            "packages:\n",
            "  - aws-cfn-bootstrap\n",
            "mounts:\n",
            { "Fn::If": [ "SwapEnabled",
              "  - ['/dev/xvdb', 'none', 'swap', 'sw', '0', '0']\n",
              { "Ref": "AWS::NoValue" }
            ] },
            "bootcmd:\n",
            { "Fn::If": [ "SwapEnabled",
              { "Fn::Join": [ "", [
                "  - mkswap /dev/xvdb\n",
                "  - swapon /dev/xvdb\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - export http_proxy=", { "Ref": "HttpProxy" }, "\n",
            "  - echo http_proxy=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export https_proxy=", { "Ref": "HttpProxy" }, "\n",
            "  - echo https_proxy=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export HTTP_PROXY=", { "Ref": "HttpProxy" }, "\n",
            "  - echo HTTP_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export HTTPS_PROXY=", { "Ref": "HttpProxy" }, "\n",
            "  - echo HTTPS_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export NO_PROXY=169.254.169.254\n",
            "  - echo NO_PROXY=169.254.169.254 >> /etc/environment\n",
            { "Fn::If": [ "HttpProxy",
              { "Fn::Join": ["", ["  - echo \"proxy=http://", { "Ref": "HttpProxy" }, "/\" >> /etc/yum.conf\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - until yum install -y aws-cli nfs-utils; do echo \"Waiting for network\"; done;\n",
            "  - export IMDS_TOKEN=$(curl -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds:21600')\n",
            "  - mkdir /volumes\n",
            { "Fn::If": [ "RegionHasEFS",
              { "Fn::Join": [ "", [
                "  - while true; do mount -t nfs -o nfsvers=4.1 $(curl -s --noproxy 169.254.169.254 -H \"X-aws-ec2-metadata-token:$IMDS_TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone).",
                { "Ref": "VolumeFilesystem" },
                ".efs.",
                { "Ref": "AWS::Region" },
                ".amazonaws.com:/ /volumes && break; sleep 5; done\n"
              ] ] },
              ""
            ] },
            "  - [ cloud-init-per, instance, docker_storage_setup, /usr/bin/docker-storage-setup ]\n",
            "  - echo ECS_CLUSTER=", { "Ref": "Cluster" }, " >> /etc/ecs/ecs.config\n",
            "  - echo ECS_ENABLE_CONTAINER_METADATA=true >> /etc/ecs/ecs.config\n",
            "  - echo ECS_ENGINE_AUTH_TYPE=docker >> /etc/ecs/ecs.config\n",
            "  - echo 'ECS_INSTANCE_ATTRIBUTES={\"asg\":\"primary\"}' >> /etc/ecs/ecs.config\n",
            "  - echo HTTP_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/ecs/ecs.config\n",
            "  - echo NO_PROXY=169.254.169.254,169.254.170.2,/var/run/docker.sock >> /etc/ecs/ecs.config\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSCA", "Value" ] }, "' | base64 -d > /etc/ca.pem\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSCert", "Value" ] }, "' | base64 -d > /etc/cert.pem\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSKey", "Value" ] }, "' | base64 -d > /etc/key.pem\n",
            "  - echo 'OPTIONS=\"--default-ulimit nofile=1024000:1024000 --log-opt max-file=2 --log-opt max-size=50m --host=unix:///var/run/docker.sock --host=0.0.0.0:2376 --tls --tlscacert /etc/ca.pem --tlscert /etc/cert.pem --tlskey /etc/key.pem\"' >> /etc/sysconfig/docker\n",
            "  - echo 'ECS_ENGINE_AUTH_DATA={\"index.docker.io\":{\"username\":\"\",\"password\":\"\",\"email\":\"\"}' >> /etc/ecs/ecs.config\n",
            "  - echo 'docker image prune -a --filter=\"until=96h\" --force' > /etc/cron.daily/docker-prune\n",
            "  - chmod +x /etc/cron.daily/docker-prune\n",
            { "Fn::If": [ "HttpProxy",
              { "Fn::Join": ["", ["  - echo \"export HTTP_PROXY=", { "Ref": "HttpProxy" }, "/\" >> /etc/sysconfig/docker\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - echo -e '/var/log/docker {\\n  rotate 7\\n  daily\\n  nocompress\\n  copytruncate\\n}' >> /etc/logrotate.d/docker\n",
            { "Fn::If": [ "BlankInstanceBootCommand",
              { "Ref": "AWS::NoValue" },
              { "Fn::Join": [ "", [
              "  - ", { "Ref": "InstanceBootCommand" }, "\n"
              ] ] }
            ] },
            "runcmd:\n",
            { "Fn::If": [ "BlankInstanceRunCommand",
              { "Ref": "AWS::NoValue" },
              { "Fn::Join": [ "", [
              "  - ", { "Ref": "InstanceRunCommand" }, "\n"
              ] ] }
            ] },
            "  - export IMDS_TOKEN=$(curl -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds:21600')\n",
            "  - export INSTANCE_ID=$(curl -s --noproxy 169.254.169.254 -H \"X-aws-ec2-metadata-token:$IMDS_TOKEN\" http://169.254.169.254/latest/meta-data/instance-id)\n",
            "  - export ASG_NAME=$(env $(cat /etc/environment) /usr/bin/aws autoscaling describe-auto-scaling-instances --instance-ids=$INSTANCE_ID --region ", {"Ref":"AWS::Region"}, " --output text --query 'AutoScalingInstances[0].AutoScalingGroupName')\n",
            "  - export LIFECYCLE_HOOK=$(env $(cat /etc/environment) /usr/bin/aws autoscaling describe-lifecycle-hooks --auto-scaling-group-name $ASG_NAME --region ", {"Ref":"AWS::Region"}, " --output text --query \"LifecycleHooks[?contains(LifecycleHookName, '", { "Ref": "AWS::StackName" }, "-InstancesLifecycleLaunching') == \\`true\\`].LifecycleHookName | [0]\")\n",
            "  - env $(cat /etc/environment) /usr/bin/aws autoscaling complete-lifecycle-action --region ", { "Ref": "AWS::Region" }, " --instance-id $INSTANCE_ID --lifecycle-hook-name $LIFECYCLE_HOOK --auto-scaling-group-name $ASG_NAME --lifecycle-action-result CONTINUE\n",
            "  - env $(cat /etc/environment) /opt/aws/bin/cfn-signal --http-proxy \"", { "Ref": "HttpProxy" }, "\" --stack ", { "Ref": "AWS::StackName" }, " --region ", { "Ref": "AWS::Region" }, " --resource Instances\n"
          ] ] }
        }
      }
    },
    "Instances": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "LaunchConfigurationName" : { "Ref": "LaunchConfiguration" },
        "VPCZoneIdentifier": {
          "Fn::If": [ "PrivateInstances", [
            { "Ref": "SubnetPrivate0" },
            { "Ref": "SubnetPrivate1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
          ], [
            { "Ref": "Subnet0" },
            { "Ref": "Subnet1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
          ] ]
        },
        "Cooldown": 5,
        "DesiredCapacity" : { "Fn::If": [ "SpotInstancesAndHA", { "Ref": "AWS::NoValue" }, { "Fn::If": [ "HighAvailability", { "Ref": "InstanceCount"}, { "Ref": "NoHaInstanceCount"} ] } ] },
        "HealthCheckType": "EC2",
        "HealthCheckGracePeriod": "120",
        "MinSize" : { "Fn::If": [ "SpotInstancesAndHA", { "Ref": "OnDemandMinCount" }, { "Fn::If": [ "HighAvailability", { "Ref": "InstanceCount"}, "1" ] } ] },
        "MaxSize" : "1000",
        "MetricsCollection": [ { "Granularity": "1Minute" } ],
        "TerminationPolicies": [ "NewestInstance" ],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Ref": "AWS::StackName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Rack",
            "Value": { "Ref": "AWS::StackName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "GatewayAttachment",
            "Value": { "Fn::If": [ "ExistingVpc", "existing", { "Ref": "GatewayAttachment" } ] },
            "PropagateAtLaunch": false
          },
          {
            "Key": "NatGateways",
            "PropagateAtLaunch": false,
            "Value": { "Fn::If": [
              "PrivateInstances",
              { "Fn::Join": [ ",", [
                { "Ref": "Nat0" },
                { "Ref": "Nat1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Nat2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] },
              ""
            ] }
          },
          { "Fn::If": [ "RegionHasEFS",
            {
              "Key": "VolumeTargets",
              "PropagateAtLaunch": false,
              "Value": { "Fn::Join": [ ",", [
                { "Ref": "VolumeTarget0" },
                { "Ref": "VolumeTarget1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "VolumeTarget2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] }
            },
            { "Ref": "AWS::NoValue" }
          ] }
        ]
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": { "Ref": "InstanceUpdateBatchSize" },
          "MinInstancesInService": { "Fn::If": [ "SpotInstancesAndHA", { "Ref": "OnDemandMinCount" }, { "Fn::If": [ "HighAvailability", { "Ref": "InstanceCount"}, "1" ] } ] },
          "PauseTime" : "PT5M",
          "SuspendProcesses": [
            "ScheduledActions"
          ],
          "WaitOnResourceSignals": "true"
        }
      }
    },
    "InstancesScheduleRackScaleDown":{
      "Type":"AWS::AutoScaling::ScheduledAction",
      "Condition": "SetScheduleRackScale",
      "Properties":{
        "AutoScalingGroupName": { "Ref": "Instances" },
        "MaxSize": "0",
        "MinSize": "0",
        "Recurrence": { "Ref": "ScheduleRackScaleDown" }
      }
    },
    "InstancesScheduleRackScaleUp":{
      "Type":"AWS::AutoScaling::ScheduledAction",
      "Condition": "SetScheduleRackScale",
      "Properties":{
        "AutoScalingGroupName": { "Ref": "Instances" },
        "DesiredCapacity" : { "Fn::If": [ "SpotInstancesAndHA", { "Ref": "AWS::NoValue" }, { "Fn::If": [ "HighAvailability", { "Ref": "InstanceCount"}, { "Ref": "NoHaInstanceCount"} ] } ] },
        "MinSize" : { "Fn::If": [ "SpotInstancesAndHA", { "Ref": "OnDemandMinCount" }, { "Fn::If": [ "HighAvailability", { "Ref": "InstanceCount"}, "1" ] } ] },
        "MaxSize" : "1000",
        "Recurrence": { "Ref": "ScheduleRackScaleUp" }
      }
    },
    "BuildScheduleRackScaleDown":{
      "Type":"AWS::AutoScaling::ScheduledAction",
      "Condition": "SetScheduleRackScale",
      "Properties":{
        "AutoScalingGroupName": { "Ref": "BuildInstances" },
        "DesiredCapacity": "0",
        "MaxSize": "0",
        "MinSize": "0",
        "Recurrence": { "Ref": "ScheduleRackScaleDown" }
      }
    },
    "BuildScheduleRackScaleUp":{
      "Type":"AWS::AutoScaling::ScheduledAction",
      "Condition": "SetScheduleRackScale",
      "Properties":{
        "AutoScalingGroupName": { "Ref": "BuildInstances" },
        "DesiredCapacity": "1",
        "MaxSize":"2",
        "MinSize":"1",
        "Recurrence": { "Ref": "ScheduleRackScaleUp" }
      }
    },
    "SpotScheduleRackScaleDown":{
      "Type":"AWS::AutoScaling::ScheduledAction",
      "Condition": "SpotInstancesAndSetScheduleRack",
      "Properties":{
        "AutoScalingGroupName": { "Ref": "SpotInstances" },
        "DesiredCapacity": "0",
        "MaxSize": "0",
        "MinSize": "0",
        "Recurrence": { "Ref": "ScheduleRackScaleDown" }
      }
    },
    "SpotScheduleRackScaleUp":{
      "Type":"AWS::AutoScaling::ScheduledAction",
      "Condition": "SpotInstancesAndSetScheduleRack",
      "Properties":{
        "AutoScalingGroupName": { "Ref": "SpotInstances" },
        "MinSize": "0",
        "MaxSize": "1000",
        "Recurrence": { "Ref": "ScheduleRackScaleUp" }
      }
    },
    "InstancesAutoscaler": {
      "Type": "AWS::Lambda::Function",
      "Condition": "Autoscale",
      "Properties": {
        "Code": {
          "S3Bucket": { "Fn::Sub": "convox-${AWS::Region}" },
          "S3Key": { "Fn::Sub": "release/${Version}/lambda/autoscale.zip" }
        },
        "Environment": {
          "Variables": {
            "ASG": { "Ref": "Instances" },
            "CLUSTER": { "Ref": "Cluster" },
            "EXTRA": { "Fn::If": [ "HighAvailability", { "Ref": "AutoscaleExtra" }, 0]},
            "HIGH_AVAILABILITY": { "Ref": "HighAvailability" },
            "REGION": { "Ref": "AWS::Region" },
            "STACK": { "Ref": "AWS::StackName" }
          }
        },
        "Handler": "handler",
        "MemorySize": "128",
        "Role": { "Fn::GetAtt": [ "ApiRole", "Arn" ] },
        "Runtime": "go1.x",
        "Timeout": "60"
      }
    },
    "InstancesAutoscalerPermission": {
      "Type": "AWS::Lambda::Permission",
      "Condition": "Autoscale",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": { "Fn::GetAtt": [ "InstancesAutoscaler", "Arn" ] },
        "Principal": "events.amazonaws.com",
        "SourceArn": { "Fn::GetAtt": [ "InstancesAutoscalerEvent", "Arn" ] }
      }
    },
    "InstancesAutoscalerEvent": {
      "Type": "AWS::Events::Rule",
      "Condition": "Autoscale",
      "Properties": {
        "ScheduleExpression": "cron(*/1 * * * ? *)",
        "Targets": [ { "Id": "InstancesAutoscaler", "Arn": { "Fn::GetAtt": [ "InstancesAutoscaler", "Arn" ] } } ]
      }
    },
    "InstancesLifecycleLaunching": {
      "Type": "AWS::AutoScaling::LifecycleHook",
      "Properties": {
        "AutoScalingGroupName": { "Ref": "Instances" },
        "DefaultResult": "CONTINUE",
        "HeartbeatTimeout": "600",
        "LifecycleTransition": "autoscaling:EC2_INSTANCE_LAUNCHING",
        "NotificationTargetARN": { "Ref": "InstancesLifecycleTopic" },
        "RoleARN": { "Fn::GetAtt": [ "InstancesLifecycleRole", "Arn" ] }
      }
    },
    "InstancesLifecycleTerminating": {
      "Type": "AWS::AutoScaling::LifecycleHook",
      "Properties": {
        "AutoScalingGroupName": { "Ref": "Instances" },
        "DefaultResult": "CONTINUE",
        "HeartbeatTimeout": "300",
        "LifecycleTransition": "autoscaling:EC2_INSTANCE_TERMINATING",
        "NotificationTargetARN": { "Ref": "InstancesLifecycleTopic" },
        "RoleARN": { "Fn::GetAtt": [ "InstancesLifecycleRole", "Arn" ] }
      }
    },
    "InstancesLifecycleRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": [ "autoscaling.amazonaws.com" ] },
              "Action": [ "sts:AssumeRole" ]
            }
          ]
        },
        "ManagedPolicyArns": [
          { "Ref": "CMKPolicy" }
        ],
        "Path": "/convox/",
        "Policies": [
          {
            "PolicyName": "InstancesLifecycleRole",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "sns:Publish"
                  ],
                  "Resource": { "Ref": "InstancesLifecycleTopic" }
                }
              ]
            }
          }
        ]
      }
    },
    "InstancesLifecycleTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "Subscription": [ { "Endpoint": { "Fn::GetAtt": [ "InstancesLifecycleHandler", "Arn" ] }, "Protocol": "lambda" } ],
        "TopicName" : { "Fn::Join": ["", [{"Ref":"AWS::StackName"}, "-lifecycle"]] }
      }
    },
    "InstancesLifecycleTopicPolicy": {
      "Type": "AWS::SNS::TopicPolicy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "events.amazonaws.com" },
              "Action": "sns:Publish",
              "Resource": { "Ref": "InstancesLifecycleTopic" }
            }
          ]
        },
        "Topics": [ { "Ref": "InstancesLifecycleTopic" } ]
      }
    },
    "InstancesLifecycleHandler": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": { "Fn::Join": [ "-", [ "convox", { "Ref": "AWS::Region" } ] ] },
          "S3Key": { "Fn::Join": [ "", [ "release/", { "Ref": "Version" }, "/lambda/lifecycle.zip" ] ] }
        },
        "Description": { "Fn::Join": [ "", [ "{\"Cluster\": \"", { "Ref": "Cluster" }, "\", \"Rack\": \"", { "Ref": "AWS::StackName" }, "\"}" ] ] },
        "Environment": {
          "Variables": {
            "CLUSTER": { "Ref": "Cluster" },
            "RACK": { "Ref": "AWS::StackName" },
            "REGION": { "Ref": "AWS::Region" }
          }
        },
        "Handler": "handler",
        "MemorySize": "128",
        "Role": { "Fn::GetAtt": [ "InstancesLifecycleHandlerRole", "Arn" ] },
        "Runtime": "go1.x",
        "Timeout": "300"
      }
    },
    "InstancesLifecycleHandlerPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Fn::GetAtt": [ "InstancesLifecycleHandler", "Arn" ] },
        "Action": "lambda:InvokeFunction",
        "Principal": "sns.amazonaws.com",
        "SourceArn": { "Ref": "InstancesLifecycleTopic" }
      }
    },
    "InstancesLifecycleHandlerRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": [ "lambda.amazonaws.com" ] },
              "Action": [ "sts:AssumeRole" ]
            }
          ]
        },
        "ManagedPolicyArns": [
          { "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole" },
          { "Ref": "CMKPolicy" }
        ],
        "Path": "/convox/",
        "Policies": [
          {
            "PolicyName": "InstancesLifecycleHandlerRole",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "autoscaling:CompleteLifecycleAction",
                    "ecs:DeregisterContainerInstance",
                    "ecs:DescribeContainerInstances",
                    "ecs:DescribeServices",
                    "ecs:DescribeTasks",
                    "ecs:ListContainerInstances",
                    "ecs:ListServices",
                    "ecs:ListTasks",
                    "ecs:StopTask",
                    "ecs:UpdateContainerInstancesState",
                    "lambda:GetFunction",
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "SpotLaunchConfiguration": {
      "Condition": "SpotInstances",
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "AssociatePublicIpAddress": { "Fn::If": [ "PrivateInstances", false, true ] },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "Encrypted": { "Fn::If": [ "EncryptEbs", "true", { "Ref": "AWS::NoValue" } ] },
              "VolumeSize": { "Ref": "VolumeSize" },
              "VolumeType":"gp3"
            }
          },
          { "Fn::If": [ "SwapEnabled",
            {
              "DeviceName": "/dev/xvdb",
              "Ebs": {
                "Encrypted": { "Fn::If": [ "EncryptEbs", "true", { "Ref": "AWS::NoValue" } ] },
                "VolumeSize": { "Ref": "SwapSize" },
                "VolumeType":"gp3"
              }
            },
            { "Ref": "AWS::NoValue" }
          ] }
        ],
        "IamInstanceProfile": { "Ref": "InstancesProfile" },
        "ImageId": {
          "Fn::If": [
            "BlankAmi",
            {
              "Fn::If": [
                "InstanceARM",
                {
                  "Ref": "DefaultAmiArm"
                },
                {
                  "Ref": "DefaultAmi"
                }
              ]
            },
            { "Ref": "Ami" }
          ]
        },
        "InstanceMonitoring": true,
        "InstanceType": { "Ref": "InstanceType" },
        "KeyName": { "Fn::If": [ "BlankKey", { "Ref": "AWS::NoValue" }, { "Ref": "Key" } ] },
        "MetadataOptions" : {
          "HttpEndpoint" : "enabled",
          "HttpTokens" : { "Ref": "IMDSHttpTokens"}
        },
        "SecurityGroups": [ { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] } ],
        "SpotPrice": { "Ref": "SpotInstanceBid" },
        "UserData": { "Fn::Base64":
          { "Fn::Join": [ "", [
            "#cloud-config\n",
            "repo_upgrade_exclude:\n",
            "  - kernel*\n",
            "packages:\n",
            "  - aws-cfn-bootstrap\n",
            "mounts:\n",
            { "Fn::If": [ "SwapEnabled",
              "  - ['/dev/xvdb', 'none', 'swap', 'sw', '0', '0']\n",
              { "Ref": "AWS::NoValue" }
            ] },
            "bootcmd:\n",
            { "Fn::If": [ "SwapEnabled",
              { "Fn::Join": [ "", [
                "  - mkswap /dev/xvdb\n",
                "  - swapon /dev/xvdb\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - export http_proxy=", { "Ref": "HttpProxy" }, "\n",
            "  - echo http_proxy=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export https_proxy=", { "Ref": "HttpProxy" }, "\n",
            "  - echo https_proxy=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export HTTP_PROXY=", { "Ref": "HttpProxy" }, "\n",
            "  - echo HTTP_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export HTTPS_PROXY=", { "Ref": "HttpProxy" }, "\n",
            "  - echo HTTPS_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/environment\n",
            "  - export NO_PROXY=169.254.169.254\n",
            "  - echo NO_PROXY=169.254.169.254 >> /etc/environment\n",
            { "Fn::If": [ "HttpProxy",
              { "Fn::Join": ["", ["  - echo \"proxy=http://", { "Ref": "HttpProxy" }, "/\" >> /etc/yum.conf\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - until yum install -y aws-cli nfs-utils; do echo \"Waiting for network\"; done;\n",
            "  - export IMDS_TOKEN=$(curl -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds:21600')\n",
            "  - mkdir /volumes\n",
            { "Fn::If": [ "RegionHasEFS",
              { "Fn::Join": [ "", [
                "  - while true; do mount -t nfs -o nfsvers=4.1 $(curl -s --noproxy 169.254.169.254 -H \"X-aws-ec2-metadata-token:$IMDS_TOKEN\" http://169.254.169.254/latest/meta-data/placement/availability-zone).",
                { "Ref": "VolumeFilesystem" },
                ".efs.",
                { "Ref": "AWS::Region" },
                ".amazonaws.com:/ /volumes && break; sleep 5; done\n"
              ] ] },
              ""
            ] },
            "  - [ cloud-init-per, instance, docker_storage_setup, /usr/bin/docker-storage-setup ]\n",
            "  - echo ECS_CLUSTER=", { "Ref": "Cluster" }, " >> /etc/ecs/ecs.config\n",
            "  - echo ECS_ENABLE_CONTAINER_METADATA=true >> /etc/ecs/ecs.config\n",
            "  - echo ECS_ENABLE_SPOT_INSTANCE_DRAINING=true >> /etc/ecs/ecs.config\n",
            "  - echo ECS_ENGINE_AUTH_TYPE=docker >> /etc/ecs/ecs.config\n",
            "  - echo 'ECS_INSTANCE_ATTRIBUTES={\"asg\":\"spot\"}' >> /etc/ecs/ecs.config\n",
            "  - echo HTTP_PROXY=", { "Ref": "HttpProxy" }, " >> /etc/ecs/ecs.config\n",
            "  - echo NO_PROXY=169.254.169.254,169.254.170.2,/var/run/docker.sock >> /etc/ecs/ecs.config\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSCA", "Value" ] }, "' | base64 -d > /etc/ca.pem\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSCert", "Value" ] }, "' | base64 -d > /etc/cert.pem\n",
            "  - echo '", { "Fn::GetAtt": [ "DockertTLSKey", "Value" ] }, "' | base64 -d > /etc/key.pem\n",
            "  - echo 'OPTIONS=\"--default-ulimit nofile=1024000:1024000 --log-opt max-file=2 --log-opt max-size=50m --host=unix:///var/run/docker.sock --host=0.0.0.0:2376 --tls --tlscacert /etc/ca.pem --tlscert /etc/cert.pem --tlskey /etc/key.pem\"' >> /etc/sysconfig/docker\n",
            "  - echo 'ECS_ENGINE_AUTH_DATA={\"index.docker.io\":{\"username\":\"\",\"password\":\"\",\"email\":\"\"}' >> /etc/ecs/ecs.config\n",
            "  - echo 'docker image prune -a --filter=\"until=96h\" --force' > /etc/cron.daily/docker-prune\n",
            "  - chmod +x /etc/cron.daily/docker-prune\n",
            { "Fn::If": [ "HttpProxy",
              { "Fn::Join": ["", ["  - echo \"export HTTP_PROXY=", { "Ref": "HttpProxy" }, "/\" >> /etc/sysconfig/docker\n"
              ] ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "  - echo -e '/var/log/docker {\\n  rotate 7\\n  daily\\n  nocompress\\n  copytruncate\\n}' >> /etc/logrotate.d/docker\n",
            { "Fn::If": [ "BlankInstanceBootCommand",
              { "Ref": "AWS::NoValue" },
              { "Fn::Join": [ "", [
              "  - ", { "Ref": "InstanceBootCommand" }, "\n"
              ] ] }
            ] },
            "runcmd:\n",
            { "Fn::If": [ "BlankInstanceRunCommand",
              { "Ref": "AWS::NoValue" },
              { "Fn::Join": [ "", [
              "  - ", { "Ref": "InstanceRunCommand" }, "\n"
              ] ] }
            ] },
            "  - export IMDS_TOKEN=$(curl -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds:21600')\n",
            "  - export INSTANCE_ID=$(curl -s --noproxy 169.254.169.254 -H \"X-aws-ec2-metadata-token:$IMDS_TOKEN\" http://169.254.169.254/latest/meta-data/instance-id)\n",
            "  - export ASG_NAME=$(env $(cat /etc/environment) /usr/bin/aws autoscaling describe-auto-scaling-instances --instance-ids=$INSTANCE_ID --region ", {"Ref":"AWS::Region"}, " --output text --query 'AutoScalingInstances[0].AutoScalingGroupName')\n",
            "  - export LIFECYCLE_HOOK=$(env $(cat /etc/environment) /usr/bin/aws autoscaling describe-lifecycle-hooks --auto-scaling-group-name $ASG_NAME --region ", {"Ref":"AWS::Region"}, " --output text --query \"LifecycleHooks[?contains(LifecycleHookName, '", { "Ref": "AWS::StackName" }, "-SpotInstancesLifecycleLaunching') == \\`true\\`].LifecycleHookName | [0]\")\n",
            "  - env $(cat /etc/environment) /usr/bin/aws autoscaling complete-lifecycle-action --region ", { "Ref": "AWS::Region" }, " --instance-id $INSTANCE_ID --lifecycle-hook-name $LIFECYCLE_HOOK --auto-scaling-group-name $ASG_NAME --lifecycle-action-result CONTINUE\n",
            "  - env $(cat /etc/environment) /opt/aws/bin/cfn-signal --http-proxy \"", { "Ref": "HttpProxy" }, "\" --stack ", { "Ref": "AWS::StackName" }, " --region ", { "Ref": "AWS::Region" }, " --resource SpotInstances\n"
          ] ] }
        }
      }
    },
    "SpotInstances": {
      "Condition": "SpotInstances",
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "LaunchConfigurationName" : { "Ref": "SpotLaunchConfiguration" },
        "VPCZoneIdentifier": {
          "Fn::If": [ "PrivateInstances", [
            { "Ref": "SubnetPrivate0" },
            { "Ref": "SubnetPrivate1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
          ], [
            { "Ref": "Subnet0" },
            { "Ref": "Subnet1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
          ] ]
        },
        "Cooldown": 5,
        "HealthCheckType": "EC2",
        "HealthCheckGracePeriod": "120",
        "MinSize": "0",
        "MaxSize": "1000",
        "MetricsCollection": [ { "Granularity": "1Minute" } ],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Ref": "AWS::StackName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Rack",
            "Value": { "Ref": "AWS::StackName" },
            "PropagateAtLaunch": true
          },
          {
            "Key": "GatewayAttachment",
            "Value": { "Fn::If": [ "ExistingVpc", "existing", { "Ref": "GatewayAttachment" } ] },
            "PropagateAtLaunch": false
          },
          {
            "Key": "InstanceCount",
            "Value": { "Ref": "InstanceCount" },
            "PropagateAtLaunch": false
          },
          {
            "Key": "NatGateways",
            "PropagateAtLaunch": false,
            "Value": { "Fn::If": [
              "PrivateInstances",
              { "Fn::Join": [ ",", [
                { "Ref": "Nat0" },
                { "Ref": "Nat1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Nat2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] },
              ""
            ] }
          },
          { "Fn::If": [ "RegionHasEFS",
            {
              "Key": "VolumeTargets",
              "PropagateAtLaunch": false,
              "Value": { "Fn::Join": [ ",", [
                { "Ref": "VolumeTarget0" },
                { "Ref": "VolumeTarget1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "VolumeTarget2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] }
            },
            { "Ref": "AWS::NoValue" }
          ] }
        ]
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": {
            "Ref": "InstanceUpdateBatchSize"
          },
          "MinInstancesInService": "0",
          "PauseTime": "PT5M",
          "SuspendProcesses": [
            "ScheduledActions"
          ],
          "WaitOnResourceSignals": "true"
        }
      }
    },
    "SpotInstancesLifecycleLaunching": {
      "Condition": "SpotInstances",
      "Type": "AWS::AutoScaling::LifecycleHook",
      "Properties": {
        "AutoScalingGroupName": {
          "Ref": "SpotInstances"
        },
        "DefaultResult": "CONTINUE",
        "HeartbeatTimeout": "600",
        "LifecycleTransition": "autoscaling:EC2_INSTANCE_LAUNCHING",
        "NotificationTargetARN": {
          "Ref": "InstancesLifecycleTopic"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "InstancesLifecycleRole",
            "Arn"
          ]
        }
      }
    },
    "SpotInstancesLifecycleTerminating": {
      "Condition": "SpotInstances",
      "Type": "AWS::AutoScaling::LifecycleHook",
      "Properties": {
        "AutoScalingGroupName": {
          "Ref": "SpotInstances"
        },
        "DefaultResult": "CONTINUE",
        "HeartbeatTimeout": "300",
        "LifecycleTransition": "autoscaling:EC2_INSTANCE_TERMINATING",
        "NotificationTargetARN": {
          "Ref": "InstancesLifecycleTopic"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "InstancesLifecycleRole",
            "Arn"
          ]
        }
      }
    },
    "VolumeFilesystem": {
      "Type": "AWS::EFS::FileSystem",
      "Condition": "RegionHasEFS",
      "Properties": {
        "FileSystemTags": [
          { "Key": "Name", "Value": { "Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, "shared-volumes" ] ] } }
        ]
      }
    },
    "VolumeSecurity": {
      "DependsOn": "ApiRole",
      "Type": "AWS::EC2::SecurityGroup",
      "Condition": "RegionHasEFS",
      "Properties": {
        "GroupDescription": { "Fn::Sub": "${AWS::StackName} volumes" },
        "SecurityGroupIngress": [ {
          "IpProtocol": "tcp",
          "FromPort": "2049",
          "ToPort": "2049",
          "SourceSecurityGroupId": { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] }
        } ],
        "Tags": [ { "Key": "Name", "Value": { "Fn::Sub": "${AWS::StackName}-volumes" } } ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc", { "Ref": "Vpc" }, { "Ref": "ExistingVpc" } ] }
      }
    },
    "VolumeTarget0": {
      "Type": "AWS::EFS::MountTarget",
      "Condition": "RegionHasEFS",
      "Properties": {
        "FileSystemId": { "Ref": "VolumeFilesystem" },
        "SubnetId": { "Fn::If": [ "PrivateInstances", { "Ref": "SubnetPrivate0" }, { "Ref": "Subnet0" } ] },
        "SecurityGroups": [ { "Ref": "VolumeSecurity" } ]
      }
    },
    "VolumeTarget1": {
      "Type": "AWS::EFS::MountTarget",
      "Condition": "RegionHasEFS",
      "Properties": {
        "FileSystemId": { "Ref": "VolumeFilesystem" },
        "SubnetId": { "Fn::If": [ "PrivateInstances", { "Ref": "SubnetPrivate1" }, { "Ref": "Subnet1" } ] },
        "SecurityGroups": [ { "Ref": "VolumeSecurity" } ]
      }
    },
    "VolumeTarget2": {
      "Type": "AWS::EFS::MountTarget",
      "Condition": "RegionHasEFSAndThirdAvailabilityZoneAndHighAvailability",
      "Properties": {
        "FileSystemId": { "Ref": "VolumeFilesystem" },
        "SubnetId": { "Fn::If": [ "PrivateInstances", { "Ref": "SubnetPrivate2" }, { "Ref": "Subnet2" } ] },
        "SecurityGroups": [ { "Ref": "VolumeSecurity" } ]
      }
    },
    "AccountEvents": {
      "Type": "AWS::SQS::Queue"
    },
    "AccountEventsPolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "Queues": [ { "Ref": "AccountEvents" } ],
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "AWS": "*" },
              "Action": "sqs:SendMessage",
              "Resource": { "Fn::GetAtt": [ "AccountEvents", "Arn" ] },
              "Condition": { "ArnEquals": { "aws:SourceArn": { "Fn::GetAtt": [ "AccountEventsRule", "Arn" ] } } }
            }
          ]
        }
      }
    },
    "AccountEventsRule": {
      "Type" : "AWS::Events::Rule",
      "Properties" : {
        "Description" : "Specified event changes",
        "EventPattern" : {
          "account":  [ { "Ref": "AWS::AccountId" } ],
          "source": [ "aws.ecs" ],
          "detail-type": [ "ECS Task State Change" ],
          "detail": { "clusterArn": [ { "Fn::Sub": "arn:${AWS::Partition}:ecs:${AWS::Region}:${AWS::AccountId}:cluster/${Cluster}" } ] }
        },
        "State" : "ENABLED",
        "Targets" : [ { "Arn": { "Fn::GetAtt": [ "AccountEvents", "Arn" ] }, "Id": "Events" } ]
      }
    },
    "CloudformationEvents": {
      "Type": "AWS::SQS::Queue"
    },
    "CloudformationEventsPolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "Queues": [ { "Ref": "CloudformationEvents" } ],
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "AWS": "*" },
              "Action": "sqs:SendMessage",
              "Resource": { "Fn::GetAtt": [ "CloudformationEvents", "Arn" ] },
              "Condition": { "ArnEquals": { "aws:SourceArn": { "Ref": "CloudformationTopic" } } }
            }
          ]
        }
      }
    },
    "CloudformationTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "DisplayName": { "Fn::Sub": "${AWS::StackName}-events" },
        "Subscription": [ { "Protocol": "sqs", "Endpoint": { "Fn::GetAtt": [ "CloudformationEvents", "Arn" ] } } ]
      }
    },
    "Router": {
      "Condition": "PublicRouter",
      "DependsOn": [ "ApiRole", "ELBLogsPolicy" ],
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "LoadBalancerAttributes": [
          { "Key": "access_logs.s3.enabled", "Value": "true" },
          { "Key": "access_logs.s3.bucket", "Value": { "Fn::If": [ "BlankLogBucket", { "Ref": "ELBLogs" }, { "Ref": "LogBucket" } ] } },
          { "Key": "access_logs.s3.prefix", "Value": { "Fn::Sub": "convox/logs/${AWS::StackName}/alb" } },
          { "Key": "idle_timeout.timeout_seconds", "Value": { "Ref": "LoadBalancerIdleTimeout" } },
          { "Key": "routing.http.desync_mitigation_mode", "Value": { "Ref": "RouterMitigationMode" } },
          { "Key": "routing.http.drop_invalid_header_fields.enabled", "Value": "true" }
        ],
        "Subnets": [
          { "Ref": "Subnet0" },
          { "Ref": "Subnet1" },
          { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
        ],
        "SecurityGroups": { "Fn::If": [ "BlankRouterSecurityGroup", [ { "Ref": "RouterSecurity" } ], { "Ref": "RouterSecurityGroup" } ] },
        "Tags": [
          { "Key": "Rack", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "RouterSecurity": {
      "Type": "AWS::EC2::SecurityGroup",
      "Condition": "PublicRouter",
      "DependsOn": "ApiRole",
      "Properties": {
        "GroupDescription": { "Fn::Sub": "${AWS::StackName} router" },
        "SecurityGroupIngress": [
          { "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80" },
          { "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp", "FromPort": "443", "ToPort": "443" }
        ],
        "Tags": [ { "Key": "Name", "Value": { "Fn::Sub": "${AWS::StackName}-router" } } ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc", { "Ref": "Vpc" }, { "Ref": "ExistingVpc" } ] }
      }
    },
    "RouterListener80": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Condition": "PublicRouter",
      "Properties": {
        "DefaultActions": [ { "Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301" } } ],
        "LoadBalancerArn": { "Ref" : "Router" },
        "Port": "80",
        "Protocol": "HTTP"
      }
    },
    "RouterListener443": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Condition": "PublicRouter",
      "Properties": {
        "Certificates": [ { "CertificateArn": { "Ref": "RouterApiCertificate" } } ],
        "DefaultActions": [ { "Type": "fixed-response", "FixedResponseConfig": { "StatusCode": "404", "MessageBody": "unknown host" } } ],
        "LoadBalancerArn": { "Ref" : "Router" },
        "Port": "443",
        "Protocol": "HTTPS",
        "SslPolicy": { "Fn::If": [ "BlankSslPolicy", { "Ref": "AWS::NoValue" }, { "Ref": "SslPolicy" } ] }
      }
    },
    "RouterApiCertificate": {
      "Type": "AWS::CertificateManager::Certificate",
      "Condition": "PublicRouter",
      "Properties": {
        "DomainName": { "Fn::Join": [ ".", [
          "*",
          { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "Router", "DNSName" ] } ] } ] },
          { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "Router", "DNSName" ] } ] } ] },
          "convox.site"
        ] ] },
        "DomainValidationOptions": [
          {
            "DomainName": { "Fn::Join": [ ".", [
              "*",
              { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "Router", "DNSName" ] } ] } ] },
              { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "Router", "DNSName" ] } ] } ] },
              "convox.site"
            ] ] },
            "ValidationDomain": "convox.site"
          }
        ]
      }
    },
    "RouterInternal": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Condition": "Internal",
      "DependsOn": [ "ApiRole", "ELBLogsPolicy" ],
      "Properties": {
        "LoadBalancerAttributes": [
          { "Key": "access_logs.s3.enabled", "Value": "true" },
          { "Key": "access_logs.s3.bucket", "Value": { "Fn::If": [ "BlankLogBucket", { "Ref": "ELBLogs" }, { "Ref": "LogBucket" } ] } },
          { "Key": "access_logs.s3.prefix", "Value": { "Fn::Sub": "convox/logs/${AWS::StackName}/alb" } },
          { "Key": "idle_timeout.timeout_seconds", "Value": "3600" }
        ],
        "Name": { "Fn::If": [ "BlankInternalSuffix", { "Ref": "AWS::NoValue" }, { "Fn::Sub": "${AWS::StackName}${InternalSuffix}" } ] },
        "Scheme": "internal",
        "Subnets": { "Fn::If": [ "Private",
          [
            { "Ref": "SubnetPrivate0" },
            { "Ref": "SubnetPrivate1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
          ],
          [
            { "Ref": "Subnet0" },
            { "Ref": "Subnet1" },
            { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
          ]
        ] },
        "SecurityGroups": { "Fn::If": [ "BlankRouterInternalSecurityGroup", [ { "Ref": "RouterInternalSecurity" } ], { "Ref": "RouterInternalSecurityGroup" } ] },
        "Tags": [
          { "Key": "Rack", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "RouterInternalSecurity": {
      "Type": "AWS::EC2::SecurityGroup",
      "Condition": "Internal",
      "DependsOn": "ApiRole",
      "Properties": {
        "GroupDescription": { "Fn::Sub": "${AWS::StackName} internal router" },
        "SecurityGroupIngress": [
          { "CidrIp": { "Ref": "VPCCIDR" }, "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80" },
          { "CidrIp": { "Ref": "VPCCIDR" }, "IpProtocol": "tcp", "FromPort": "443", "ToPort": "443" }
        ],
        "Tags": [ { "Key": "Name", "Value": { "Fn::Sub": "${AWS::StackName}-router-internal" } } ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc", { "Ref": "Vpc" }, { "Ref": "ExistingVpc" } ] }
      }
    },
    "RouterInternalListener80": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Condition": "Internal",
      "Properties": {
        "DefaultActions": [ { "Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301" } } ],
        "LoadBalancerArn": { "Ref" : "RouterInternal" },
        "Port": "80",
        "Protocol": "HTTP"
      }
    },
    "RouterInternalListener443": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Condition": "Internal",
      "Properties": {
        "Certificates": [ { "CertificateArn": { "Ref": "RouterInternalCertificate" } } ],
        "DefaultActions": [ { "Type": "fixed-response", "FixedResponseConfig": { "StatusCode": "404", "MessageBody": "unknown host" } } ],
        "LoadBalancerArn": { "Ref" : "RouterInternal" },
        "Port": "443",
        "Protocol": "HTTPS",
        "SslPolicy": { "Fn::If": [ "BlankSslPolicy", { "Ref": "AWS::NoValue" }, { "Ref": "SslPolicy" } ] }
      }
    },
    "RouterInternalCertificate": {
      "Type": "AWS::CertificateManager::Certificate",
      "Condition": "Internal",
      "Properties": {
        "DomainName": { "Fn::Join": [ ".", [
          "*",
          { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "RouterInternal", "DNSName" ] } ] } ] },
          { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "RouterInternal", "DNSName" ] } ] } ] },
          "convox.site"
        ] ] },
        "DomainValidationOptions": [
          {
            "DomainName": { "Fn::Join": [ ".", [
              "*",
              { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "RouterInternal", "DNSName" ] } ] } ] },
              { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "RouterInternal", "DNSName" ] } ] } ] },
              "convox.site"
            ] ] },
            "ValidationDomain": "convox.site"
          }
        ]
      }
    },
    "ApiBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "DependsOn": [ "ApiRole", "LogsPolicy" ],
      "Properties": {
        "Name": { "Fn::If": [ "PrivateApi", { "Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, "i" ] ] }, { "Ref": "AWS::StackName" } ] },
        "LoadBalancerAttributes": [
          { "Key": "access_logs.s3.enabled", "Value": "true" },
          { "Key": "access_logs.s3.bucket", "Value": { "Fn::If": [ "BlankLogBucket", { "Ref": "ELBLogs" }, { "Ref": "LogBucket" } ] } },
          { "Key": "access_logs.s3.prefix", "Value": { "Fn::Sub": "convox/logs/${AWS::StackName}/alb" } },
          { "Key": "idle_timeout.timeout_seconds", "Value": { "Ref": "LoadBalancerIdleTimeout" } },
          { "Key": "routing.http.desync_mitigation_mode", "Value": { "Ref": "RouterMitigationMode" } },
          { "Key": "routing.http.drop_invalid_header_fields.enabled", "Value": "true" }
        ],
        "Scheme": { "Fn::If": [ "PrivateApi", "internal", "internet-facing" ] },
        "Subnets": {
          "Fn::If": [ "PrivateApi",
            [ { "Ref": "SubnetPrivate0" }, { "Ref": "SubnetPrivate1" }, { "Fn::If": [ "CreateThirdPrivateSubnet", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] } ],
            [ { "Ref": "Subnet0" }, { "Ref": "Subnet1" }, { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] } ]
          ]
        },
        "SecurityGroups": [ { "Ref": "ApiBalancerSecurity" } ],
        "Tags": [
          { "Key": "Rack", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "ApiBalancerCertificate": {
      "Type": "AWS::CertificateManager::Certificate",
      "Properties": {
        "DomainName": { "Fn::Join": [ ".", [
          "*",
          { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
          { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
          "convox.site"
        ] ] },
        "DomainValidationOptions": [
          {
            "DomainName": { "Fn::Join": [ ".", [
              "*",
              { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
              { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
              "convox.site"
            ] ] },
            "ValidationDomain": "convox.site"
          }
        ]
      }
    },
    "ApiBalancerListener443": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "Certificates": [ { "CertificateArn": { "Ref": "ApiBalancerCertificate" } } ],
        "DefaultActions": [ { "Type": "fixed-response", "FixedResponseConfig": { "StatusCode": "404", "MessageBody": "unknown host" } } ],
        "LoadBalancerArn": { "Ref" : "ApiBalancer" },
        "Port": "443",
        "Protocol": "HTTPS",
        "SslPolicy": { "Fn::If": [ "BlankSslPolicy", { "Ref": "AWS::NoValue" }, { "Ref": "SslPolicy" } ] }
      }
    },
    "ApiBalancerTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "DependsOn": "ApiBalancerListener443",
      "Properties": {
        "HealthCheckIntervalSeconds": "5",
        "HealthCheckTimeoutSeconds": "3",
        "HealthyThresholdCount": "2",
        "UnhealthyThresholdCount": "2",
        "HealthCheckPath": "/check",
        "Matcher": { "HttpCode": "200" },
        "Port": { "Fn::If": ["PrivateApi", "4100", "4000"] },
        "Protocol": "HTTPS",
        "TargetGroupAttributes": [
          { "Key": "deregistration_delay.timeout_seconds", "Value": "30" }
        ],
        "TargetType": "instance",
        "VpcId": { "Fn::If": [ "BlankExistingVpc", { "Ref": "Vpc" }, { "Ref": "ExistingVpc" } ] }
      }
    },
    "ApiBalancerListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "Actions": [ { "Type": "forward", "TargetGroupArn": { "Ref": "ApiBalancerTargetGroup" } } ],
        "Conditions": [
          { "Field": "host-header", "Values": [ { "Fn::Join": [ ".", [
            "rack",
            { "Fn::Select": [ 0, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
            { "Fn::Select": [ 1, { "Fn::Split": [ ".", { "Fn::GetAtt": [ "ApiBalancer", "DNSName" ] } ] } ] },
            "convox.site"
          ] ] } ] }
        ],
        "ListenerArn": { "Ref": "ApiBalancerListener443" },
        "Priority": "1"
      }
    },
    "ApiBalancerListenerRuleInternal": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "Actions": [ { "Type": "forward", "TargetGroupArn": { "Ref": "ApiBalancerTargetGroup" } } ],
        "Conditions": [
          { "Field": "host-header", "Values": [ { "Fn::Join": [ ".", [
            "rack",
            {"Ref": "AWS::StackName"},
            "convox"
          ] ] } ] }
        ],
        "ListenerArn": { "Ref": "ApiBalancerListener443" },
        "Priority": "2"
      }
    },
    "ApiBalancerSecurity": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": { "Fn::Sub": "${AWS::StackName} balancer" },
        "SecurityGroupIngress": [
          {
            "CidrIp": { "Fn::If": [ "PrivateApi",
              { "Fn::If": [ "BlankPrivateApiSecurityGroup",
                { "Ref": "VPCCIDR" },
                { "Ref": "AWS::NoValue" }
              ] },
              "0.0.0.0/0"
            ] },
            "SourceSecurityGroupId": { "Fn::If": [ "PrivateApi",
              { "Fn::If": [ "BlankPrivateApiSecurityGroup",
                { "Ref": "AWS::NoValue" },
                { "Ref": "PrivateApiSecurityGroup" }
              ] },
              { "Ref": "AWS::NoValue" }
            ] },
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443"
          }
        ],
        "Tags": [ { "Key": "Name", "Value": { "Fn::Sub": "${AWS::StackName}-balancer" } } ],
        "VpcId": { "Fn::If": [ "BlankExistingVpc", { "Ref": "Vpc" }, { "Ref": "ExistingVpc" } ] }
      }
    },
    "Cluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "CapacityProviders": [
          "FARGATE",
          "FARGATE_SPOT"
        ]
      }
    },
    "ServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [ { "Effect": "Allow", "Principal": { "Service": [ "ecs.amazonaws.com" ] }, "Action": [ "sts:AssumeRole" ] } ],
          "Version": "2012-10-17"
        },
        "ManagedPolicyArns": [
          { "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2ContainerServiceRole" },
          { "Ref": "CMKPolicy" }
        ],
        "Path": "/convox/"
      }
    },
    "ApiPolicy": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "Path": "/convox/",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [ "iam:*" ],
              "Resource": [
                { "Fn::Sub": "arn:${AWS::Partition}:iam::*:instance-profile/convox/*" },
                { "Fn::Sub": "arn:${AWS::Partition}:iam::*:policy/convox/*" },
                { "Fn::Sub": "arn:${AWS::Partition}:iam::*:role/convox/*" },
                { "Fn::Sub": "arn:${AWS::Partition}:iam::*:user/convox/*" }
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "iam:DeleteServerCertificate",
                "iam:DetachRolePolicy",
                "iam:GetRole",
                "iam:GetServerCertificate",
                "iam:ListServerCertificates",
                "iam:PassRole",
                "iam:UploadServerCertificate"
              ],
              "Resource": [ "*" ]
            }
          ]
        }
      }
    },
    "ApiRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            { "Effect": "Allow", "Principal": { "Service": [ "ecs-tasks.amazonaws.com" ] }, "Action": [ "sts:AssumeRole" ] },
            { "Effect": "Allow", "Principal": { "Service": [ "lambda.amazonaws.com" ] }, "Action": [ "sts:AssumeRole" ] }
          ],
          "Version": "2012-10-17"
        },
        "ManagedPolicyArns": [
          { "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/PowerUserAccess" },
          { "Ref": "ApiPolicy" },
          { "Ref": "CMKPolicy" }
        ],
        "Path": "/convox/",
        "Policies": [
          {
            "PolicyName": "ApiRole",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "lambda:GetFunction"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "ServiceMonitorApi": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [ "Instances" ],
      "Properties": {
        "Cluster": { "Ref": "Cluster" },
        "DeploymentConfiguration": { "MinimumHealthyPercent": "100", "MaximumPercent": "200" },
        "DesiredCount": "1",
        "PlacementConstraints": [ { "Type": "memberOf", "Expression": "attribute:asg == primary" } ],
        "TaskDefinition": { "Ref": "ApiMonitorTasks" }
      }
    },
    "ServiceWebApi": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [ "Instances", "ApiBalancerListenerRule" ],
      "Properties": {
        "Cluster": { "Ref": "Cluster" },
        "DeploymentConfiguration": { "MinimumHealthyPercent": { "Fn::If": [ "HighAvailability", "50", "0" ] }, "MaximumPercent": "200" },
        "DesiredCount": { "Fn::If": [ "HighAvailability", { "Ref": "ApiCount" }, 1 ] },
        "LoadBalancers": [ { "ContainerName": "web", "ContainerPort": "5443", "TargetGroupArn": { "Ref": "ApiBalancerTargetGroup" } }],
        "Role": { "Fn::GetAtt": [ "ServiceRole", "Arn" ] },
        "TaskDefinition": { "Ref": "ApiWebTasks" }
      }
    },
    "ApiBuildTasks": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            "Cpu": { "Ref": "BuildCpu" },
            "DockerLabels": {
              "convox.release": { "Ref": "Version" },
              "rack.BuildCluster": { "Fn::If": [ "DedicatedBuilder", { "Ref": "BuildCluster" }, { "Ref": "Cluster" } ] },
              "rack.CloudformationTopic": { "Ref": "CloudformationTopic" },
              "rack.Cluster": { "Ref": "Cluster" },
              "rack.DynamoBuilds": { "Ref": "DynamoBuilds" },
              "rack.DynamoReleases": { "Ref": "DynamoReleases" },
              "rack.EcsPollInterval": { "Ref": "EcsPollInterval" },
              "rack.LogDriver": { "Ref": "LogDriver" },
              "rack.EncryptionKey": { "Ref": "EncryptionKey" },
              "rack.Fargate": { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "Fargate" ] },
              "rack.HighAvailability": { "Ref": "HighAvailability" },
              "rack.Internal": { "Ref": "Internal" },
              "rack.InternalOnly": { "Ref": "InternalOnly" },
              "rack.LogBucket": { "Fn::If": [ "BlankLogBucket", { "Ref": "Logs" }, { "Ref": "LogBucket" } ] },
              "rack.NotificationTopic": { "Ref": "NotificationTopic" },
              "rack.OnDemandMinCount": { "Ref": "OnDemandMinCount" },
              "rack.Private": { "Ref": "Private" },
              "rack.PrivateBuild": { "Ref": "PrivateBuild" },
              "rack.SecurityGroup": { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] },
              "rack.SettingsBucket": { "Ref": "Settings" },
              "rack.SpotInstances": { "Fn::If": [ "SpotInstances", "Yes", "No" ] },
              "rack.Subnets": { "Fn::Join": [ ",", [
                { "Ref": "Subnet0" },
                { "Ref": "Subnet1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] },
              "rack.SubnetsPrivate": { "Fn::If": [ "Private",
                { "Fn::Join": [ ",", [
                  { "Ref": "SubnetPrivate0" },
                  { "Ref": "SubnetPrivate1" },
                  { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
                ] ] },
                { "Ref": "AWS::NoValue" }
              ] },
              "rack.SyslogDestination": { "Ref": "SyslogDestination" },
              "rack.SyslogFormat": { "Ref": "SyslogFormat" },
              "rack.Version": { "Ref": "Version" },
              "rack.Vpc": { "Fn::If": [ "BlankExistingVpc",
                { "Ref": "Vpc" },
                { "Ref": "ExistingVpc" }
              ] },
              "rack.VpcCidr": { "Ref": "VPCCIDR" }
            },
            "Environment": [
              { "Name": "AWS_REGION", "Value": { "Ref": "AWS::Region" } },
              { "Name": "NO_PROXY", "Value": "169.254.169.254,169.254.170.2,/var/run/docker.sock" },
              { "Name": "HTTP_PROXY", "Value": { "Ref": "HttpProxy" } },
              { "Name": "HTTPS_PROXY", "Value": { "Ref": "HttpProxy" } },
              { "Name": "PASSWORD", "Value": { "Ref": "Password" } },
              { "Name": "PROVIDER", "Value": "aws" },
              { "Name": "RACK", "Value": { "Ref": "AWS::StackName" } },
              { "Name": "STACK_ID", "Value": { "Ref": "AWS::StackId" } }
            ],
            "Image": {
              "Fn::If": [
                "BlankBuildImage",
                {
                  "Fn::If": [
                    "InstanceARM",
                    { "Fn::Sub": "convox/rack:${Version}-arm64" },
                    { "Fn::Sub": "convox/rack:${Version}" }
                  ]
                },
                { "Ref": "BuildImage" }
              ]
            },
            "LinuxParameters": {
              "InitProcessEnabled": "true"
            },
            "Memory": { "Ref": "BuildMemory" },
            "MountPoints": [
              { "SourceVolume": "config", "ContainerPath": "/etc/sysconfig/docker" },
              { "SourceVolume": "docker", "ContainerPath": "/var/run/docker.sock" }
            ],
            "Name": "build"
          }
        ],
        "Family": { "Fn::Sub": "${AWS::StackName}-build" },
        "TaskRoleArn": { "Fn::GetAtt": [ "ApiRole", "Arn" ] },
        "Volumes": [
          { "Name": "config", "Host": { "SourcePath": "/etc/sysconfig/docker" } },
          { "Name": "docker", "Host": { "SourcePath": "/var/run/docker.sock" } }
        ]
      }
    },
    "ApiMonitorTasks": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [ "/go/bin/monitor" ],
            "Cpu": "64",
            "DockerLabels": {
              "convox.release": { "Ref": "Version" },
              "rack.BuildCluster": { "Fn::If": [ "DedicatedBuilder", { "Ref": "BuildCluster" }, { "Ref": "Cluster" } ] },
              "rack.CloudformationTopic": { "Ref": "CloudformationTopic" },
              "rack.Cluster": { "Ref": "Cluster" },
              "rack.DynamoBuilds": { "Ref": "DynamoBuilds" },
              "rack.DynamoReleases": { "Ref": "DynamoReleases" },
              "rack.EcsPollInterval": { "Ref": "EcsPollInterval" },
              "rack.LogDriver": { "Ref": "LogDriver" },
              "rack.EncryptionKey": { "Ref": "EncryptionKey" },
              "rack.Fargate": { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "Fargate" ] },
              "rack.HighAvailability": { "Ref": "HighAvailability" },
              "rack.Internal": { "Ref": "Internal" },
              "rack.InternalOnly": { "Ref": "InternalOnly" },
              "rack.LogBucket": { "Fn::If": [ "BlankLogBucket", { "Ref": "Logs" }, { "Ref": "LogBucket" } ] },
              "rack.NotificationTopic": { "Ref": "NotificationTopic" },
              "rack.OnDemandMinCount": { "Ref": "OnDemandMinCount" },
              "rack.Private": { "Ref": "Private" },
              "rack.PrivateBuild": { "Ref": "PrivateBuild" },
              "rack.SecurityGroup": { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] },
              "rack.SettingsBucket": { "Ref": "Settings" },
              "rack.SpotInstances": { "Fn::If": [ "SpotInstances", "Yes", "No" ] },
              "rack.Subnets": { "Fn::Join": [ ",", [
                { "Ref": "Subnet0" },
                { "Ref": "Subnet1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] },
              "rack.SubnetsPrivate": { "Fn::If": [ "Private",
                { "Fn::Join": [ ",", [
                  { "Ref": "SubnetPrivate0" },
                  { "Ref": "SubnetPrivate1" },
                  { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
                ] ] },
                { "Ref": "AWS::NoValue" }
              ] },
              "rack.SyslogDestination": { "Ref": "SyslogDestination" },
              "rack.SyslogFormat": { "Ref": "SyslogFormat" },
              "rack.Version": { "Ref": "Version" },
              "rack.Vpc": { "Fn::If": [ "BlankExistingVpc",
                { "Ref": "Vpc" },
                { "Ref": "ExistingVpc" }
              ] },
              "rack.VpcCidr": { "Ref": "VPCCIDR" }
            },
            "Environment": [
              { "Name": "AWS_REGION", "Value": { "Ref": "AWS::Region" } },
              { "Name": "CLIENT_ID", "Value": { "Ref": "ClientId" } },
              { "Name": "NO_PROXY", "Value": "169.254.169.254,169.254.170.2,/var/run/docker.sock" },
              { "Name": "HTTP_PROXY", "Value": { "Ref": "HttpProxy" } },
              { "Name": "HTTPS_PROXY", "Value": { "Ref": "HttpProxy" } },
              { "Name": "PASSWORD", "Value": { "Ref": "Password" } },
              { "Name": "PROVIDER", "Value": "aws" },
              { "Name": "RACK", "Value": { "Ref": "AWS::StackName" } },
              { "Name": "STACK_ID", "Value": { "Ref": "AWS::StackId" } }
            ],
            "Image": {
              "Fn::If": [
                "InstanceARM",
                { "Fn::Sub": "convox/rack:${Version}-arm64" },
                { "Fn::Sub": "convox/rack:${Version}" }
              ]
            },
            "LinuxParameters": {
              "InitProcessEnabled": "true"
            },
            "LogConfiguration": {
              "Fn::If": [
                "EnableSyslog",
                {
                  "LogDriver": "syslog",
                  "Options": {
                    "syslog-address": { "Ref": "SyslogDestination" },
                    "syslog-format": { "Ref": "SyslogFormat" }
                  }
                },
                {
                  "Fn::If": [
                    "EnableCloudWatch",
                    {
                      "LogDriver": "awslogs",
                      "Options": {
                        "awslogs-region": { "Ref": "AWS::Region" },
                        "awslogs-group": { "Ref": "LogGroup" },
                        "awslogs-stream-prefix": "service"
                      }
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            },
            "Memory": { "Ref": "ApiMonitorMemory" },
            "MountPoints": [ { "SourceVolume": "docker", "ContainerPath": "/var/run/docker.sock" } ],
            "Name": "monitor"
          }
        ],
        "Family": { "Fn::Sub": "${AWS::StackName}-monitor" },
        "TaskRoleArn": { "Fn::GetAtt": [ "ApiRole", "Arn" ] },
        "Volumes": [ { "Name": "docker", "Host": { "SourcePath": "/var/run/docker.sock" } } ]
      }
    },
    "ApiWebTasks": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [ "/go/bin/rack" ],
            "Cpu": { "Ref": "ApiCpu" },
            "DockerLabels": {
              "convox.release": { "Ref": "Version" },
              "rack.AsgSpot": { "Fn::If": [ "SpotInstances", { "Ref": "SpotInstances" }, { "Ref": "AWS::NoValue" } ] },
              "rack.AsgStandard": { "Ref": "Instances" },
              "rack.AvailabilityZones": { "Fn::If": [ "BlankAvailabilityZones",
                { "Fn::Join": [ ",", [
                  { "Fn::Select": [ 0, { "Fn::GetAZs": "" } ] },
                  { "Fn::Select": [ 1, { "Fn::GetAZs": "" } ] },
                  { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability",
                    { "Fn::Select": [ 2, { "Fn::GetAZs": "" } ] },
                    { "Ref": "AWS::NoValue" }
                  ] }
                ] ] },
                { "Fn::Join": [ ",", [
                  { "Fn::Select": [ 0, { "Ref": "AvailabilityZones" } ] },
                  { "Fn::Select": [ 1, { "Ref": "AvailabilityZones" } ] },
                  { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability",
                    { "Fn::Select": [ 2, { "Ref": "AvailabilityZones" } ] },
                    { "Ref": "AWS::NoValue" }
                  ] }
                ] ] }
              ] },
              "rack.BuildCluster": { "Fn::If": [ "DedicatedBuilder", { "Ref": "BuildCluster" }, { "Ref": "Cluster" } ] },
              "rack.CloudformationTopic": { "Ref": "CloudformationTopic" },
              "rack.Cluster": { "Ref": "Cluster" },
              "rack.CustomEncryptionKey": { "Ref": "EncryptionKey" },
              "rack.DynamoBuilds": { "Ref": "DynamoBuilds" },
              "rack.DynamoReleases": { "Ref": "DynamoReleases" },
              "rack.DockerTlsCA": { "Fn::GetAtt": [ "DockertTLSCA", "Value" ] },
              "rack.DockerTlsCAKey": { "Fn::GetAtt": [ "DockertTLSCAKey", "Value" ] },
              "rack.DockerTlsCert": { "Fn::GetAtt": [ "DockertTLSCert", "Value" ] },
              "rack.DockerTlsKey": { "Fn::GetAtt": [ "DockertTLSKey", "Value" ] },
              "rack.EcsPollInterval": { "Ref": "EcsPollInterval" },
              "rack.LogDriver": { "Ref": "LogDriver" },
              "rack.EncryptionKey": { "Ref": "EncryptionKey" },
              "rack.Fargate": { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "Fargate" ] },
              "rack.HighAvailability": { "Ref": "HighAvailability" },
              "rack.Internal": { "Ref": "Internal" },
              "rack.InternalOnly": { "Ref": "InternalOnly" },
              "rack.LogBucket": { "Fn::If": [ "BlankLogBucket", { "Ref": "Logs" }, { "Ref": "LogBucket" } ] },
              "rack.NotificationTopic": { "Ref": "NotificationTopic" },
              "rack.OnDemandMinCount": { "Ref": "OnDemandMinCount" },
              "rack.Private": { "Ref": "Private" },
              "rack.PrivateBuild": { "Ref": "PrivateBuild" },
              "rack.SecurityGroup": { "Fn::If": [ "BlankInstanceSecurityGroup", { "Ref": "InstancesSecurity" }, { "Ref": "InstanceSecurityGroup" } ] },
              "rack.SettingsBucket": { "Ref": "Settings" },
              "rack.SshKey": { "Ref": "Key" },
              "rack.SpotInstances": { "Fn::If": [ "SpotInstances", "Yes", "No" ] },
              "rack.Subnets": { "Fn::Join": [ ",", [
                { "Ref": "Subnet0" },
                { "Ref": "Subnet1" },
                { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "Subnet2" }, { "Ref": "AWS::NoValue" } ] }
              ] ] },
              "rack.SubnetsPrivate": { "Fn::If": [ "Private",
                { "Fn::Join": [ ",", [
                  { "Ref": "SubnetPrivate0" },
                  { "Ref": "SubnetPrivate1" },
                  { "Fn::If": [ "ThirdAvailabilityZoneAndHighAvailability", { "Ref": "SubnetPrivate2" }, { "Ref": "AWS::NoValue" } ] }
                ] ] },
                { "Ref": "AWS::NoValue" }
              ] },
              "rack.SyslogDestination": { "Ref": "SyslogDestination" },
              "rack.SyslogFormat": { "Ref": "SyslogFormat" },
              "rack.Version": { "Ref": "Version" },
              "rack.Vpc": { "Fn::If": [ "BlankExistingVpc",
                { "Ref": "Vpc" },
                { "Ref": "ExistingVpc" }
              ] },
              "rack.VpcCidr": { "Ref": "VPCCIDR" }
            },
            "Environment": [
              { "Name": "AWS_REGION", "Value": { "Ref": "AWS::Region" } },
              { "Name": "CLIENT_ID", "Value": { "Ref": "ClientId" } },
              { "Name": "NO_PROXY", "Value": "169.254.169.254,169.254.170.2,/var/run/docker.sock" },
              { "Name": "HTTP_PROXY", "Value": { "Ref": "HttpProxy" } },
              { "Name": "HTTPS_PROXY", "Value": { "Ref": "HttpProxy" } },
              { "Name": "PASSWORD", "Value": { "Ref": "Password" } },
              { "Name": "PROVIDER", "Value": "aws" },
              { "Name": "RACK", "Value": { "Ref": "AWS::StackName" } },
              { "Name": "STACK_ID", "Value": { "Ref": "AWS::StackId" } }
            ],
            "Image": {
              "Fn::If": [
                "InstanceARM",
                { "Fn::Sub": "convox/rack:${Version}-arm64" },
                { "Fn::Sub": "convox/rack:${Version}" }
              ]
            },
            "LinuxParameters": {
              "InitProcessEnabled": "true"
            },
            "LogConfiguration": {
              "Fn::If": [
                "EnableSyslog",
                {
                  "LogDriver": "syslog",
                  "Options": {
                    "syslog-address": { "Ref": "SyslogDestination" },
                    "syslog-format": { "Ref": "SyslogFormat" }
                  }
                },
                {
                  "Fn::If": [
                    "EnableCloudWatch",
                    {
                      "LogDriver": "awslogs",
                      "Options": {
                        "awslogs-region": { "Ref": "AWS::Region" },
                        "awslogs-group": { "Ref": "LogGroup" },
                        "awslogs-stream-prefix": "service"
                      }
                    },
                    {
                      "Ref": "AWS::NoValue"
                    }
                  ]
                }
              ]
            },
            "MemoryReservation": { "Ref": "ApiWebMemory" },
            "MountPoints": [ { "SourceVolume": "docker", "ContainerPath": "/var/run/docker.sock" } ],
            "Name": "web",
            "PortMappings": { "Fn::If": [ "PrivateApi",
              [ { "HostPort": "4100", "ContainerPort": "5443", "Protocol": "tcp" } ],
              [ { "HostPort": "4000", "ContainerPort": "5443", "Protocol": "tcp" } ]
            ] }
          }
        ],
        "Family": { "Fn::Sub": "${AWS::StackName}-web" },
        "TaskRoleArn": { "Fn::GetAtt": [ "ApiRole", "Arn" ] },
        "Volumes": [ { "Name": "docker", "Host": { "SourcePath": "/var/run/docker.sock" } } ]
      }
    },
    "DynamoBuilds": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": { "Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, "builds" ] ] },
        "AttributeDefinitions": [
          { "AttributeName": "id", "AttributeType": "S" },
          { "AttributeName": "app", "AttributeType": "S" },
          { "AttributeName": "created", "AttributeType": "S" }
        ],
        "BillingMode": "PAY_PER_REQUEST",
        "KeySchema": [ { "AttributeName": "id", "KeyType": "HASH" } ],
        "GlobalSecondaryIndexes": [ {
          "IndexName": "app.created",
          "KeySchema": [ { "AttributeName": "app", "KeyType": "HASH" }, { "AttributeName": "created", "KeyType": "RANGE" } ],
          "Projection": { "ProjectionType": "ALL" }
        }]
      }
    },
    "DynamoReleases": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": { "Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, "releases" ] ] },
        "AttributeDefinitions": [
          { "AttributeName": "id", "AttributeType": "S" },
          { "AttributeName": "app", "AttributeType": "S" },
          { "AttributeName": "created", "AttributeType": "S" }
        ],
        "BillingMode": "PAY_PER_REQUEST",
        "KeySchema": [ { "AttributeName": "id", "KeyType": "HASH" } ],
        "GlobalSecondaryIndexes": [{
          "IndexName": "app.created",
          "KeySchema": [ { "AttributeName": "app", "KeyType": "HASH" }, { "AttributeName": "created", "KeyType": "RANGE" } ],
          "Projection": { "ProjectionType": "ALL" }
        }]
      }
    },
    "CMKPolicy": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "Description": "Access to the Customer Managed key for iam roles",
        "Path": "/convox/",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey"
              ],
              "Resource": [
                { "Fn::GetAtt": ["CustomerManagedKey", "Arn"]}
              ]
            }
          ]
        }
      }
    },
    "CustomerManagedKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": { "Fn::Sub": "Customer Managed Key (CMK) used by Convox to encrypt ${AWS::StackName} S3 bucket" },
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Id": "cmk-s3-buckets",
          "Statement": [
            {
              "Sid": "key administration",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": [
                "kms:*"
              ],
              "Resource": "*"
            },
            {
              "Sid": "Cloud Trail permissions",
              "Principal": { "Service": [ "cloudtrail.amazonaws.com" ] },
              "Action": [
                "kms:DescribeKey",
                "kms:GenerateDataKey"
              ],
              "Effect": "Allow",
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          { "Key": "System", "Value": "convox" },
          { "Key": "Rack", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "Logs": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Retain",
      "Properties": {
        "AccessControl": "LogDeliveryWrite",
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [ {
            "BucketKeyEnabled": true,
            "ServerSideEncryptionByDefault": {
              "SSEAlgorithm": "aws:kms",
              "KMSMasterKeyID": { "Ref": "CustomerManagedKey" }
            }
          } ]
        },
        "LifecycleConfiguration": { "Fn::If": [ "BlankLogRetention",
          { "Ref": "AWS::NoValue" },
          { "Rules": [ { "ExpirationInDays": { "Ref": "LogRetention" }, "Status": "Enabled" } ] }
        ] },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          { "Key": "System", "Value": "convox" },
          { "Key": "Rack", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "LogsPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "Logs" },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowSSLRequestsOnly",
              "Action": "s3:*",
              "Effect": "Deny",
              "Resource": [
                { "Fn::GetAtt": ["Logs", "Arn"]},
                {
                  "Fn::Sub": [
                    "${bucket}/*",
                    {
                      "bucket": { "Fn::GetAtt": ["Logs", "Arn"] }
                    }
                  ]
                }
              ],
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false"
                }
              },
              "Principal": "*"
            }
          ]
        }
      }
    },
    "Settings": {
      "Type": "AWS::S3::Bucket",
      "DependsOn": "LogsPolicy",
      "DeletionPolicy": "Retain",
      "Properties": {
        "AccessControl": "Private",
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [ {
            "BucketKeyEnabled": true,
            "ServerSideEncryptionByDefault": {
              "SSEAlgorithm": "aws:kms",
              "KMSMasterKeyID": { "Ref": "CustomerManagedKey" }
            }
          } ]
        },
        "LoggingConfiguration": {
          "DestinationBucketName": { "Fn::If": [ "BlankLogBucket", { "Ref": "Logs" }, { "Ref": "LogBucket" } ] },
          "LogFilePrefix": { "Fn::Sub": "convox/logs/${AWS::StackName}/s3/" }
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          { "Key": "System", "Value": "convox" },
          { "Key": "Rack", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "SettingsPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "Settings" },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowSSLRequestsOnly",
              "Action": "s3:*",
              "Effect": "Deny",
              "Resource": [
                { "Fn::GetAtt": ["Settings", "Arn"]},
                {
                  "Fn::Sub": [
                    "${bucket}/*",
                    {
                      "bucket": { "Fn::GetAtt": ["Settings", "Arn"] }
                    }
                  ]
                }
              ],
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false"
                }
              },
              "Principal": "*"
            }
          ]
        }
      }
    },
    "ELBLogs": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Retain",
      "Properties": {
        "AccessControl": "LogDeliveryWrite",
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [ {
            "ServerSideEncryptionByDefault": { "SSEAlgorithm": "aws:kms" }
          } ]
        },
        "LifecycleConfiguration": { "Fn::If": [ "BlankLogRetention",
          { "Ref": "AWS::NoValue" },
          { "Rules": [ { "ExpirationInDays": { "Ref": "LogRetention" }, "Status": "Enabled" } ] }
        ] },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          { "Key": "System", "Value": "convox" },
          { "Key": "Type", "Value": "ELB" },
          { "Key": "Rack", "Value": { "Ref": "AWS::StackName" } }
        ]
      }
    },
    "ELBLogsPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "ELBLogs" },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "ELB log delivery service",
              "Effect": "Allow",
              "Principal": { "AWS": { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "ELBAccountId" ] } },
              "Action": "s3:PutObject",
              "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::${ELBLogs}/*" }
            },
            {
              "Sid": "AllowSSLRequestsOnly",
              "Action": "s3:*",
              "Effect": "Deny",
              "Resource": [
                { "Fn::GetAtt": ["ELBLogs", "Arn"]},
                {
                  "Fn::Sub": [
                    "${bucket}/*",
                    {
                      "bucket": { "Fn::GetAtt": ["ELBLogs", "Arn"] }
                    }
                  ]
                }
              ],
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false"
                }
              },
              "Principal": "*"
            }
          ]
        }
      }
    }
  }
}
