#!/bin/bash

set -e

go get -t ./...

rm -f coverage.txt

if [ ! -z ${TEST} ]; then
    if [ ! -z ${TESTRUN} ]; then
        echo "Running single test $TESTRUN"
        go test -coverprofile=profile.out -covermode=atomic "$TEST" -test.run "$TESTRUN"
        exit
    fi

    go test -coverprofile=profile.out -covermode=atomic "$TEST"
    exit
fi

for d in $(find . -not \( -name vendor -prune \) -name '*.go' -exec dirname {} \; | sort -u); do
  go test -coverprofile=profile.out -covermode=atomic $d

  if [ -f profile.out ]; then
    cat profile.out >> coverage.txt
    rm profile.out
  fi
done
