#!/bin/bash
set -ex -o pipefail

# Running locally:
#
#   export CIRCLE_ARTIFACTS=/tmp/
#   export CIRCLE_BUILD_NUM=0
#   ./ci/tests/example-app <repo from convox-examples>

# HACK: example-apps `parallel` wrapper, and its different stdin behavior for first process
[[ $1 == null ]] && exit 0

export EXAMPLE_NAME=$1

# inferred
export CIRCLE_BUILD_NUM=${CIRCLE_BUILD_NUM:-0}
export APP_NAME=${EXAMPLE_NAME}-${CIRCLE_BUILD_NUM}
export STACK_NAME=convox-${CIRCLE_BUILD_NUM}

git clone https://github.com/convox-examples/${EXAMPLE_NAME}.git
cd ${EXAMPLE_NAME}

convox apps create $APP_NAME --wait

convox deploy --app $APP_NAME --wait

convox apps info --app $APP_NAME

convox scale web --count 2 --memory 128 --app $APP_NAME --wait

balancer=$(convox api get /apps/$APP_NAME/formation | jq -r '.[] | select(.name == "web" and .ports[] == 443) | .balancer')
curl -vi -m2 --retry 60 --retry-delay 20 -k https://$balancer

convox ps --stats --app $APP_NAME

convox run --app $APP_NAME web 'bin/test || true'

convox logs --app $APP_NAME --follow=false --since=25m > $CIRCLE_ARTIFACTS/$APP_NAME.log
